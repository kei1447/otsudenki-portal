[{"filePath":"C:\\Users\\hibino\\otsudenki-portal\\eslint.config.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hibino\\otsudenki-portal\\next.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hibino\\otsudenki-portal\\postcss.config.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hibino\\otsudenki-portal\\src\\app\\(main)\\inventory\\actions.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":18,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":18,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[554,557],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[554,557],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":55,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":55,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1621,1624],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1621,1624],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":111,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":111,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3321,3324],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3321,3324],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":192,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":192,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5479,5482],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5479,5482],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":259,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":259,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7485,7488],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7485,7488],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":333,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":333,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9553,9556],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9553,9556],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":386,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":386,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11080,11083],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11080,11083],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":448,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":448,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12804,12807],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12804,12807],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":468,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":468,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13398,13401],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13398,13401],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":595,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":595,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[17148,17151],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[17148,17151],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":626,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":626,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[17999,18002],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[17999,18002],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":710,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":710,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[20349,20352],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[20349,20352],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":750,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":750,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[21215,21218],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[21215,21218],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":13,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use server';\n\nimport { createClient } from '@/utils/supabase/server';\nimport { revalidatePath } from 'next/cache';\n\n// 共通: 在庫がある製品のみ取得\nexport async function getStockProductsByPartner(partnerId: string) {\n  const supabase = await createClient();\n  const { data } = await supabase\n    .from('inventory')\n    .select('stock_finished, products!inner(id, name, product_code, color)')\n    .eq('products.partner_id', partnerId)\n    .gt('stock_finished', 0)\n    .order('products(product_code)');\n\n  return (\n    data?.map((d) => {\n      const p = d.products as any;\n      return {\n        id: p.id,\n        name: p.name,\n        product_code: p.product_code,\n        color: p.color,\n        stock_finished: d.stock_finished,\n      };\n    }) || []\n  );\n}\n\n// 共通: 生地在庫がある製品 ＋ 入荷履歴リスト を取得\nexport async function getRawStockProductsByPartner(partnerId: string) {\n  const supabase = await createClient();\n\n  const { data: stockData } = await supabase\n    .from('inventory')\n    .select(\n      'product_id, stock_raw, products!inner(id, name, product_code, color)'\n    )\n    .eq('products.partner_id', partnerId)\n    .gt('stock_raw', 0)\n    .order('products(product_code)');\n\n  if (!stockData || stockData.length === 0) return [];\n\n  const productIds = stockData.map((d) => d.product_id);\n  const { data: movements } = await supabase\n    .from('inventory_movements')\n    .select('product_id, created_at, quantity_change, due_date')\n    .in('product_id', productIds)\n    .eq('movement_type', 'receiving')\n    .order('created_at', { ascending: false })\n    .limit(300);\n\n  return stockData.map((item) => {\n    const p = item.products as any;\n    const arrivals =\n      movements\n        ?.filter((m) => m.product_id === item.product_id)\n        .slice(0, 5)\n        .map((m) => {\n          const date = new Date(m.created_at).toLocaleDateString('ja-JP', {\n            month: 'numeric',\n            day: 'numeric',\n          });\n          const due = m.due_date\n            ? `(納期:${new Date(m.due_date).toLocaleDateString('ja-JP', { month: 'numeric', day: 'numeric' })})`\n            : '';\n          return {\n            label: `${date}${due} : ${m.quantity_change}個入荷`,\n            value: new Date(m.created_at).toISOString().split('T')[0],\n          };\n        }) || [];\n\n    return {\n      id: p.id,\n      name: p.name,\n      product_code: p.product_code,\n      color: p.color,\n      stock_raw: item.stock_raw,\n      arrivals: arrivals,\n    };\n  });\n}\n\n// 共通: 不良在庫がある製品 ＋ 詳細\nexport async function getDefectiveProductsByPartner(partnerId: string) {\n  const supabase = await createClient();\n\n  const { data: stockData } = await supabase\n    .from('inventory')\n    .select(\n      'product_id, stock_defective, products!inner(id, name, product_code, color)'\n    )\n    .eq('products.partner_id', partnerId)\n    .gt('stock_defective', 0)\n    .order('products(product_code)');\n\n  if (!stockData || stockData.length === 0) return [];\n\n  const productIds = stockData.map((d) => d.product_id);\n  const { data: movements } = await supabase\n    .from('inventory_movements')\n    .select(\n      'product_id, movement_type, quantity_change, defect_reason, created_at, due_date'\n    )\n    .in('product_id', productIds)\n    .order('created_at', { ascending: false })\n    .limit(300);\n\n  return stockData.map((item) => {\n    const p = item.products as any;\n    const pLogs =\n      movements?.filter((m) => m.product_id === item.product_id) || [];\n\n    const defectLogs = pLogs\n      .filter(\n        (m) =>\n          m.defect_reason !== null ||\n          ['production_defective', 'defect_found'].includes(m.movement_type)\n      )\n      .slice(0, 3)\n      .map((l) => ({\n        reason: l.defect_reason || '理由なし',\n        date: new Date(l.created_at).toLocaleDateString('ja-JP', {\n          month: 'numeric',\n          day: 'numeric',\n        }),\n      }));\n\n    const arrivalLogs = pLogs\n      .filter((m) => m.movement_type === 'receiving')\n      .slice(0, 3)\n      .map((l) => ({\n        date: new Date(l.created_at).toLocaleDateString('ja-JP', {\n          month: 'numeric',\n          day: 'numeric',\n        }),\n        qty: l.quantity_change,\n      }));\n\n    return {\n      id: p.id,\n      name: p.name,\n      product_code: p.product_code,\n      color: p.color,\n      stock_defective: item.stock_defective,\n      recent_defects: defectLogs,\n      recent_arrivals: arrivalLogs,\n    };\n  });\n}\n\n// 共通: 特定取引先の製品取得\nexport async function getProductsByPartner(partnerId: string) {\n  const supabase = await createClient();\n  const { data } = await supabase\n    .from('products')\n    .select('id, name, product_code, color')\n    .eq('partner_id', partnerId)\n    .eq('is_discontinued', false)\n    .order('product_code');\n  return data || [];\n}\n\n// 1. 受入登録\nexport async function registerReceiving(data: {\n  productId: number;\n  quantity: number;\n  dueDate: string;\n}) {\n  const supabase = await createClient();\n  const {\n    data: { user },\n  } = await supabase.auth.getUser();\n  if (!user) return { success: false, message: '要ログイン' };\n\n  try {\n    await supabase.rpc('increment_stock', {\n      p_product_id: data.productId,\n      p_amount: data.quantity,\n      p_field: 'stock_raw',\n    });\n    await supabase.from('inventory_movements').insert({\n      product_id: data.productId,\n      movement_type: 'receiving',\n      quantity_change: data.quantity,\n      due_date: data.dueDate,\n      created_by: user.id,\n    });\n    revalidatePath('/inventory');\n    return { success: true, message: '受入登録完了' };\n  } catch (e: any) {\n    return { success: false, message: e.message };\n  }\n}\n\n// 2. 加工実績登録\nexport async function registerProduction(data: {\n  productId: number;\n  rawUsed: number;\n  finished: number;\n  defective: number;\n  defectReason?: string;\n  sourceDate?: string;\n}) {\n  const supabase = await createClient();\n  const {\n    data: { user },\n  } = await supabase.auth.getUser();\n  if (!user) return { success: false, message: '要ログイン' };\n\n  try {\n    const sourceMemo = data.sourceDate ? ` (入荷日: ${data.sourceDate})` : '';\n    if (data.rawUsed > 0) {\n      await supabase.rpc('increment_stock', {\n        p_product_id: data.productId,\n        p_amount: -data.rawUsed,\n        p_field: 'stock_raw',\n      });\n      await supabase.from('inventory_movements').insert({\n        product_id: data.productId,\n        movement_type: 'production_raw',\n        quantity_change: -data.rawUsed,\n        reason: `加工投入${sourceMemo}`,\n        created_by: user.id,\n      });\n    }\n    if (data.finished > 0) {\n      await supabase.rpc('increment_stock', {\n        p_product_id: data.productId,\n        p_amount: data.finished,\n        p_field: 'stock_finished',\n      });\n      await supabase.from('inventory_movements').insert({\n        product_id: data.productId,\n        movement_type: 'production_finished',\n        quantity_change: data.finished,\n        reason: `良品完成${sourceMemo}`,\n        created_by: user.id,\n      });\n    }\n    if (data.defective > 0) {\n      await supabase.rpc('increment_stock', {\n        p_product_id: data.productId,\n        p_amount: data.defective,\n        p_field: 'stock_defective',\n      });\n      await supabase.from('inventory_movements').insert({\n        product_id: data.productId,\n        movement_type: 'production_defective',\n        quantity_change: data.defective,\n        defect_reason: data.defectReason,\n        reason: `不良発生${sourceMemo}`,\n        created_by: user.id,\n      });\n    }\n    revalidatePath('/inventory');\n    return { success: true, message: '加工実績登録完了' };\n  } catch (e: any) {\n    return { success: false, message: e.message };\n  }\n}\n\n// 3. 出荷登録\nexport async function registerShipment(data: {\n  partnerId: string;\n  shipmentDate: string;\n  items: { productId: number; quantity: number }[];\n}) {\n  const supabase = await createClient();\n  const {\n    data: { user },\n  } = await supabase.auth.getUser();\n  if (!user) return { success: false, message: '要ログイン' };\n\n  try {\n    const { data: shipment, error: sErr } = await supabase\n      .from('shipments')\n      .insert({\n        partner_id: data.partnerId,\n        shipment_date: data.shipmentDate,\n        status: 'confirmed',\n        created_by: user.id,\n      })\n      .select()\n      .single();\n    if (sErr) throw sErr;\n\n    let total = 0;\n    for (const item of data.items) {\n      const { data: price } = await supabase\n        .from('prices')\n        .select('unit_price')\n        .eq('product_id', item.productId)\n        .eq('status', 'active')\n        .lte('valid_from', data.shipmentDate)\n        .order('valid_from', { ascending: false })\n        .limit(1)\n        .single();\n\n      const unitPrice = price?.unit_price || 0;\n      const lineTotal = unitPrice * item.quantity;\n      total += lineTotal;\n\n      await supabase.from('shipment_items').insert({\n        shipment_id: shipment.id,\n        product_id: item.productId,\n        quantity: item.quantity,\n        unit_price: unitPrice,\n        line_total: lineTotal,\n      });\n\n      await supabase.rpc('increment_stock', {\n        p_product_id: item.productId,\n        p_amount: -item.quantity,\n        p_field: 'stock_finished',\n      });\n      await supabase.from('inventory_movements').insert({\n        product_id: item.productId,\n        movement_type: 'shipping',\n        quantity_change: -item.quantity,\n        reason: `出荷No.${shipment.id.substring(0, 8)}`,\n        created_by: user.id,\n      });\n    }\n\n    await supabase\n      .from('shipments')\n      .update({ total_amount: total })\n      .eq('id', shipment.id);\n    revalidatePath('/inventory');\n    return { success: true, message: '出荷登録完了' };\n  } catch (e: any) {\n    return { success: false, message: '出荷エラー: ' + e.message };\n  }\n}\n\n// 4. 不良品処理\nexport async function registerDefectiveProcessing(data: {\n  productId: number;\n  reworkQty: number;\n  returnQty: number;\n}) {\n  const supabase = await createClient();\n  const {\n    data: { user },\n  } = await supabase.auth.getUser();\n  if (!user) return { success: false, message: '要ログイン' };\n\n  try {\n    if (data.reworkQty > 0) {\n      await supabase.rpc('increment_stock', {\n        p_product_id: data.productId,\n        p_amount: -data.reworkQty,\n        p_field: 'stock_defective',\n      });\n      await supabase.rpc('increment_stock', {\n        p_product_id: data.productId,\n        p_amount: data.reworkQty,\n        p_field: 'stock_finished',\n      });\n      await supabase.from('inventory_movements').insert({\n        product_id: data.productId,\n        movement_type: 'repair',\n        quantity_change: data.reworkQty,\n        reason: '不良手直し完了',\n        created_by: user.id,\n      });\n    }\n    if (data.returnQty > 0) {\n      await supabase.rpc('increment_stock', {\n        p_product_id: data.productId,\n        p_amount: -data.returnQty,\n        p_field: 'stock_defective',\n      });\n      await supabase.from('inventory_movements').insert({\n        product_id: data.productId,\n        movement_type: 'return_defective',\n        quantity_change: -data.returnQty,\n        reason: '不良品返却',\n        created_by: user.id,\n      });\n    }\n    revalidatePath('/inventory');\n    return { success: true, message: '処理完了' };\n  } catch (e: any) {\n    return { success: false, message: e.message };\n  }\n}\n\n// 履歴取得\nexport async function getProductHistory(productId: number) {\n  const supabase = await createClient();\n  const { data } = await supabase\n    .from('inventory_movements')\n    .select('*')\n    .eq('product_id', productId)\n    .order('created_at', { ascending: false })\n    .limit(20);\n  return data || [];\n}\n\n// 履歴削除\nexport async function deleteMovement(movementId: string) {\n  const supabase = await createClient();\n  const { data: movement } = await supabase\n    .from('inventory_movements')\n    .select('*')\n    .eq('id', movementId)\n    .single();\n  if (!movement) return { success: false, message: 'データなし' };\n\n  let field = '';\n  switch (movement.movement_type) {\n    case 'receiving':\n      field = 'stock_raw';\n      break;\n    case 'production_raw':\n      field = 'stock_raw';\n      break;\n    case 'production_finished':\n      field = 'stock_finished';\n      break;\n    case 'production_defective':\n      field = 'stock_defective';\n      break;\n    case 'shipping':\n      field = 'stock_finished';\n      break;\n    case 'repair':\n      try {\n        await supabase.rpc('increment_stock', {\n          p_product_id: movement.product_id,\n          p_amount: -movement.quantity_change,\n          p_field: 'stock_finished',\n        });\n        await supabase.rpc('increment_stock', {\n          p_product_id: movement.product_id,\n          p_amount: movement.quantity_change,\n          p_field: 'stock_defective',\n        });\n        await supabase\n          .from('inventory_movements')\n          .delete()\n          .eq('id', movementId);\n        revalidatePath('/inventory');\n        return { success: true, message: '取り消しました' };\n      } catch (e: any) {\n        return { success: false, message: e.message };\n      }\n    case 'return_defective':\n      field = 'stock_defective';\n      break;\n    default:\n      return { success: false, message: '削除不可' };\n  }\n\n  const reverseAmount = -movement.quantity_change;\n  try {\n    await supabase.rpc('increment_stock', {\n      p_product_id: movement.product_id,\n      p_amount: reverseAmount,\n      p_field: field,\n    });\n    await supabase.from('inventory_movements').delete().eq('id', movementId);\n    revalidatePath('/inventory');\n    return { success: true, message: '取り消しました' };\n  } catch (e: any) {\n    return { success: false, message: e.message };\n  }\n}\n\n// 全体履歴取得\nexport async function getGlobalHistory() {\n  const supabase = await createClient();\n  const { data } = await supabase\n    .from('inventory_movements')\n    .select(`*, products ( name, product_code, color, partners ( name ) )`)\n    .order('created_at', { ascending: false })\n    .limit(50);\n  return data || [];\n}\n\n// 一括削除\nexport async function bulkDeleteMovements(ids: string[]) {\n  let successCount = 0;\n  let errorCount = 0;\n  for (const id of ids) {\n    const res = await deleteMovement(id);\n    if (res.success) successCount++;\n    else errorCount++;\n  }\n  revalidatePath('/inventory');\n  return {\n    success: true,\n    message: `${successCount}件成功 ${errorCount > 0 ? `(${errorCount}件失敗)` : ''}`,\n  };\n}\n\n// 履歴完全削除（物理削除）\nexport async function purgeMovements(ids: string[]) {\n  const supabase = await createClient();\n  const { error } = await supabase\n    .from('inventory_movements')\n    .delete()\n    .in('id', ids);\n  if (error) return { success: false, message: '削除エラー: ' + error.message };\n  revalidatePath('/inventory');\n  return {\n    success: true,\n    message: `${ids.length}件の履歴を完全に削除しました`,\n  };\n}\n\n// 納品書データの取得 (印刷用)\nexport async function getShipmentForPrint(shipmentId: string) {\n  const supabase = await createClient();\n  const { data: shipment } = await supabase\n    .from('shipments')\n    .select(`*, partners ( name, address, phone )`)\n    .eq('id', shipmentId)\n    .single();\n\n  if (!shipment) return null;\n  const { data: items } = await supabase\n    .from('shipment_items')\n    .select(`*, products ( name, product_code, color, unit_weight )`)\n    .eq('shipment_id', shipmentId)\n    .order('products(product_code)');\n  return { ...shipment, items: items || [] };\n}\n\n// 直近の出荷履歴を取得 (出荷画面表示用)\nexport async function getRecentShipments(partnerId?: string) {\n  const supabase = await createClient();\n  let query = supabase\n    .from('shipments')\n    .select('id, shipment_date, total_amount, partners(name), created_at')\n    .order('created_at', { ascending: false })\n    .limit(10);\n  if (partnerId) query = query.eq('partner_id', partnerId);\n  const { data } = await query;\n  return data || [];\n}\n\n// 納品書一覧の取得 (管理画面用)\nexport async function getShipmentList() {\n  const supabase = await createClient();\n  const { data } = await supabase\n    .from('shipments')\n    .select(`*, partners ( name )`)\n    .order('shipment_date', { ascending: false })\n    .order('created_at', { ascending: false })\n    .limit(100);\n  return data || [];\n}\n\n// 納品書の取り消し\nexport async function deleteShipment(shipmentId: string) {\n  const supabase = await createClient();\n  const {\n    data: { user },\n  } = await supabase.auth.getUser();\n  if (!user) return { success: false, message: '要ログイン' };\n  const { data: shipment } = await supabase\n    .from('shipments')\n    .select('*, shipment_items(*)')\n    .eq('id', shipmentId)\n    .single();\n  if (!shipment) return { success: false, message: 'データが見つかりません' };\n\n  try {\n    for (const item of shipment.shipment_items) {\n      await supabase.rpc('increment_stock', {\n        p_product_id: item.product_id,\n        p_amount: item.quantity,\n        p_field: 'stock_finished',\n      });\n      await supabase.from('inventory_movements').insert({\n        product_id: item.product_id,\n        movement_type: 'shipping_cancel',\n        quantity_change: item.quantity,\n        reason: `納品書取消(No.${shipment.id.substring(0, 8)})`,\n        created_by: user.id,\n      });\n    }\n    const { error } = await supabase\n      .from('shipments')\n      .delete()\n      .eq('id', shipmentId);\n    if (error) throw error;\n    revalidatePath('/inventory');\n    revalidatePath('/shipments');\n    return { success: true, message: '納品書を取り消しました' };\n  } catch (e: any) {\n    return { success: false, message: '削除エラー: ' + e.message };\n  }\n}\n\n// 請求書作成候補の検索\nexport type InvoiceCandidate = {\n  partner: { id: string; name: string };\n  shipment_count: number;\n  total_amount_excl_tax: number;\n};\nexport async function getUnbilledSummary(\n  closingDate: number,\n  startDate: string,\n  endDate: string\n) {\n  const supabase = await createClient();\n  const { data: shipments } = await supabase\n    .from('shipments')\n    .select(`total_amount, partners!inner ( id, name, closing_date )`)\n    .is('invoice_id', null)\n    .eq('partners.closing_date', closingDate)\n    .gte('shipment_date', startDate)\n    .lte('shipment_date', endDate);\n\n  if (!shipments) return [];\n\n  const summaryMap = new Map<string, InvoiceCandidate>();\n\n  shipments.forEach((s) => {\n    // ★修正: 型エラー回避のために any にキャストして安全にアクセス\n    const p = s.partners as any;\n    const pId = p.id;\n\n    if (!summaryMap.has(pId)) {\n      summaryMap.set(pId, {\n        partner: { id: pId, name: p.name },\n        shipment_count: 0,\n        total_amount_excl_tax: 0,\n      });\n    }\n    const current = summaryMap.get(pId)!;\n    current.shipment_count += 1;\n    current.total_amount_excl_tax += s.total_amount;\n  });\n\n  return Array.from(summaryMap.values());\n}\n\n// 未請求出荷データ（詳細）取得\nexport async function getUnbilledShipments(\n  partnerId: string,\n  startDate: string,\n  endDate: string\n) {\n  const supabase = await createClient();\n  const { data: shipments } = await supabase\n    .from('shipments')\n    .select(\n      `\n      id, shipment_date, delivery_note_number, total_amount,\n      shipment_items ( id, quantity, unit_price, line_total, products ( name, product_code, color ) ),\n      partners ( name )\n    `\n    )\n    .eq('partner_id', partnerId)\n    .is('invoice_id', null)\n    .gte('shipment_date', startDate)\n    .lte('shipment_date', endDate)\n    .order('shipment_date', { ascending: true });\n  return shipments || [];\n}\n\n// 請求書作成（確定）\nexport async function createSingleInvoice(\n  partnerId: string,\n  periodStart: string,\n  periodEnd: string,\n  totalExclTax: number\n) {\n  const supabase = await createClient();\n  const {\n    data: { user },\n  } = await supabase.auth.getUser();\n  if (!user) return { success: false, message: '要ログイン' };\n  try {\n    const subtotal = totalExclTax;\n    const tax = Math.floor(subtotal * 0.1);\n    const total = subtotal + tax;\n    const { data: invoice, error: invError } = await supabase\n      .from('invoices')\n      .insert({\n        partner_id: partnerId,\n        period_start: periodStart,\n        period_end: periodEnd,\n        issue_date: new Date().toISOString(),\n        subtotal: subtotal,\n        tax_amount: tax,\n        total_amount: total,\n        status: 'confirmed',\n        created_by: user.id,\n      })\n      .select()\n      .single();\n    if (invError) throw invError;\n    const { error: shipError } = await supabase\n      .from('shipments')\n      .update({ invoice_id: invoice.id })\n      .eq('partner_id', partnerId)\n      .is('invoice_id', null)\n      .gte('shipment_date', periodStart)\n      .lte('shipment_date', periodEnd);\n    if (shipError) throw shipError;\n    revalidatePath('/invoices');\n    return { success: true, message: '請求書を作成しました' };\n  } catch (e: any) {\n    return { success: false, message: '作成エラー: ' + e.message };\n  }\n}\n\n// 請求書一覧取得\nexport async function getInvoices() {\n  const supabase = await createClient();\n  const { data } = await supabase\n    .from('invoices')\n    .select(`*, partners ( name )`)\n    .order('created_at', { ascending: false })\n    .limit(50);\n  return data || [];\n}\n\n// 全在庫データの取得 (型エラー回避済み)\nexport async function getAllInventory() {\n  const supabase = await createClient();\n  const { data } = await supabase\n    .from('inventory')\n    .select(\n      `\n      stock_raw,\n      stock_finished,\n      stock_defective,\n      last_updated_at,\n      products!inner (\n        id,\n        name,\n        product_code,\n        color,\n        partners ( name )\n      )\n    `\n    )\n    .order('last_updated_at', { ascending: false });\n\n  return (\n    data?.map((d) => {\n      const p = d.products as any;\n      const partner = Array.isArray(p.partners) ? p.partners[0] : p.partners;\n\n      return {\n        product_id: p.id,\n        stock_raw: d.stock_raw,\n        stock_finished: d.stock_finished,\n        stock_defective: d.stock_defective,\n        last_updated_at: d.last_updated_at,\n        products: {\n          name: p.name,\n          product_code: p.product_code,\n          color: p.color,\n          partners: partner,\n        },\n      };\n    }) || []\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hibino\\otsudenki-portal\\src\\app\\(main)\\inventory\\inventory-list.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":254,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":254,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9062,9065],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9062,9065],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\hibino\\otsudenki-portal\\src\\app\\(main)\\inventory\\inventory-list.tsx:260:5\n  258 |   // ここで useEffect を使っていますが、import がないとエラーになります\n  259 |   useEffect(() => {\n> 260 |     loadHistory();\n      |     ^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  261 |   }, [productId]);\n  262 |\n  263 |   const handleDelete = async (id: string, type: string) => {","line":260,"column":5,"nodeType":null,"endLine":260,"endColumn":16},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadHistory'. Either include it or remove the dependency array.","line":261,"column":6,"nodeType":"ArrayExpression","endLine":261,"endColumn":17,"suggestions":[{"desc":"Update the dependencies array to be: [loadHistory, productId]","fix":{"range":[9193,9204],"text":"[loadHistory, productId]"}}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useState, useMemo, useEffect } from 'react'; // ★ここに useEffect が必要です\nimport { getProductHistory, deleteMovement } from './actions';\n\ntype InventoryItem = {\n  product_id: number;\n  stock_raw: number;\n  stock_finished: number;\n  stock_defective: number;\n  last_updated_at: string;\n  products: {\n    name: string;\n    product_code: string;\n    color: string | null;\n    partners: { name: string } | null;\n  } | null;\n};\n\ntype Movement = {\n  id: string;\n  movement_type: string;\n  quantity_change: number;\n  created_at: string;\n  reason: string | null;\n  defect_reason: string | null;\n  due_date: string | null;\n  profiles: { email: string } | null;\n};\n\nexport default function InventoryList({\n  inventory,\n}: {\n  inventory: InventoryItem[];\n}) {\n  // 在庫ゼロ表示フラグ (デフォルトOFF)\n  const [showZeroStock, setShowZeroStock] = useState(false);\n\n  const groupedData = useMemo(() => {\n    const groups = new Map<string, InventoryItem[]>();\n    inventory.forEach((item) => {\n      // フィルタリング処理\n      const totalStock =\n        item.stock_raw + item.stock_finished + item.stock_defective;\n      if (!showZeroStock && totalStock === 0) return;\n\n      const partnerName = item.products?.partners?.name || 'その他';\n      if (!groups.has(partnerName)) groups.set(partnerName, []);\n      groups.get(partnerName)?.push(item);\n    });\n    return groups;\n  }, [inventory, showZeroStock]);\n\n  return (\n    <div className=\"space-y-4\">\n      {/* 表示切替スイッチ */}\n      <div className=\"flex justify-end mb-2\">\n        <label className=\"inline-flex items-center cursor-pointer\">\n          <input\n            type=\"checkbox\"\n            className=\"sr-only peer\"\n            checked={showZeroStock}\n            onChange={(e) => setShowZeroStock(e.target.checked)}\n          />\n          <div className=\"relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600\"></div>\n          <span className=\"ms-3 text-sm font-medium text-gray-700\">\n            在庫ゼロも含めて表示\n          </span>\n        </label>\n      </div>\n\n      {Array.from(groupedData.entries()).map(([partnerName, items]) => (\n        <InventoryAccordion\n          key={partnerName}\n          partnerName={partnerName}\n          items={items}\n        />\n      ))}\n\n      {inventory.length === 0 && (\n        <div className=\"p-8 text-center bg-gray-50 rounded-lg text-gray-500\">\n          データがありません\n        </div>\n      )}\n    </div>\n  );\n}\n\nfunction InventoryAccordion({\n  partnerName,\n  items,\n}: {\n  partnerName: string;\n  items: InventoryItem[];\n}) {\n  const [isOpen, setIsOpen] = useState(false);\n  const totalRaw = items.reduce((sum, i) => sum + i.stock_raw, 0);\n  const totalFinished = items.reduce((sum, i) => sum + i.stock_finished, 0);\n  const totalDefective = items.reduce((sum, i) => sum + i.stock_defective, 0);\n\n  // 履歴モーダル管理\n  const [historyTarget, setHistoryTarget] = useState<{\n    id: number;\n    name: string;\n  } | null>(null);\n\n  return (\n    <div className=\"border border-gray-200 rounded-lg bg-white overflow-hidden shadow-sm\">\n      <button\n        onClick={() => setIsOpen(!isOpen)}\n        className=\"w-full flex items-center justify-between p-4 bg-gray-50 hover:bg-gray-100 transition-colors\"\n      >\n        <div className=\"flex items-center gap-3\">\n          <span\n            className={`transform transition-transform text-gray-400 ${isOpen ? 'rotate-90' : ''}`}\n          >\n            ▶\n          </span>\n          <span className=\"font-bold text-lg text-gray-800\">{partnerName}</span>\n          <span className=\"text-sm text-gray-500\">({items.length}製品)</span>\n        </div>\n        <div className=\"flex gap-4 text-sm\">\n          <div className=\"flex flex-col items-end\">\n            <span className=\"text-xs text-gray-500\">生地</span>\n            <span className=\"font-bold\">{totalRaw.toLocaleString()}</span>\n          </div>\n          <div className=\"flex flex-col items-end border-l pl-4 border-gray-300\">\n            <span className=\"text-xs text-gray-500\">完成</span>\n            <span className=\"font-bold text-blue-700\">\n              {totalFinished.toLocaleString()}\n            </span>\n          </div>\n          {totalDefective > 0 && (\n            <div className=\"flex flex-col items-end border-l pl-4 border-gray-300\">\n              <span className=\"text-xs text-gray-500\">不良</span>\n              <span className=\"font-bold text-red-600\">\n                {totalDefective.toLocaleString()}\n              </span>\n            </div>\n          )}\n        </div>\n      </button>\n\n      {isOpen && (\n        <div className=\"border-t border-gray-200\">\n          <table className=\"min-w-full divide-y divide-gray-200\">\n            <thead className=\"bg-gray-50\">\n              <tr>\n                <th className=\"px-6 py-2 text-left text-xs font-medium text-gray-500 w-32\">\n                  型番\n                </th>\n                <th className=\"px-6 py-2 text-left text-xs font-medium text-gray-500\">\n                  品名\n                </th>\n                <th className=\"px-6 py-2 text-right text-xs font-medium text-gray-500 w-20 bg-yellow-50/50\">\n                  生地\n                </th>\n                <th className=\"px-6 py-2 text-right text-xs font-medium text-gray-500 w-20 bg-blue-50/50\">\n                  完成\n                </th>\n                <th className=\"px-6 py-2 text-right text-xs font-medium text-gray-500 w-20 bg-red-50/50\">\n                  不良\n                </th>\n                <th className=\"px-6 py-2 text-center text-xs font-medium text-gray-500 w-20\">\n                  履歴\n                </th>\n              </tr>\n            </thead>\n            <tbody className=\"divide-y divide-gray-200 bg-white\">\n              {items.map((item) => (\n                <tr key={item.product_id} className=\"hover:bg-gray-50\">\n                  <td className=\"px-6 py-3 text-sm font-mono text-gray-900\">\n                    {item.products?.product_code}\n                  </td>\n                  <td className=\"px-6 py-3 text-sm text-gray-600\">\n                    {item.products?.name}{' '}\n                    <span className=\"text-xs text-gray-400\">\n                      {item.products?.color}\n                    </span>\n                  </td>\n                  <td className=\"px-6 py-3 text-right text-sm font-bold bg-yellow-50/30\">\n                    {item.stock_raw > 0 ? item.stock_raw.toLocaleString() : '-'}\n                  </td>\n                  <td className=\"px-6 py-3 text-right text-sm font-bold text-blue-700 bg-blue-50/30\">\n                    {item.stock_finished > 0\n                      ? item.stock_finished.toLocaleString()\n                      : '-'}\n                  </td>\n                  <td className=\"px-6 py-3 text-right text-sm font-bold text-red-600 bg-red-50/30\">\n                    {item.stock_defective > 0\n                      ? item.stock_defective.toLocaleString()\n                      : '-'}\n                  </td>\n                  <td className=\"px-6 py-3 text-center\">\n                    <button\n                      onClick={() =>\n                        setHistoryTarget({\n                          id: item.product_id,\n                          name: `${item.products?.product_code} ${item.products?.name}`,\n                        })\n                      }\n                      className=\"text-gray-400 hover:text-indigo-600\"\n                      title=\"履歴を確認・修正\"\n                    >\n                      <svg\n                        xmlns=\"http://www.w3.org/2000/svg\"\n                        fill=\"none\"\n                        viewBox=\"0 0 24 24\"\n                        strokeWidth={1.5}\n                        stroke=\"currentColor\"\n                        className=\"w-5 h-5\"\n                      >\n                        <path\n                          strokeLinecap=\"round\"\n                          strokeLinejoin=\"round\"\n                          d=\"M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z\"\n                        />\n                      </svg>\n                    </button>\n                  </td>\n                </tr>\n              ))}\n            </tbody>\n          </table>\n        </div>\n      )}\n\n      {historyTarget && (\n        <HistoryModal\n          productId={historyTarget.id}\n          productName={historyTarget.name}\n          onClose={() => setHistoryTarget(null)}\n        />\n      )}\n    </div>\n  );\n}\n\nfunction HistoryModal({\n  productId,\n  productName,\n  onClose,\n}: {\n  productId: number;\n  productName: string;\n  onClose: () => void;\n}) {\n  const [history, setHistory] = useState<Movement[]>([]);\n  const [isLoading, setIsLoading] = useState(true);\n\n  const loadHistory = async () => {\n    setIsLoading(true);\n    const data = await getProductHistory(productId);\n    setHistory(data as any[]);\n    setIsLoading(false);\n  };\n\n  // ここで useEffect を使っていますが、import がないとエラーになります\n  useEffect(() => {\n    loadHistory();\n  }, [productId]);\n\n  const handleDelete = async (id: string, type: string) => {\n    if (!confirm('この操作を取り消しますか？\\n在庫数が元に戻ります。')) return;\n    // 出荷の削除は注意喚起\n    if (type === 'shipping') {\n      if (\n        !confirm(\n          '警告: 出荷データを取り消すと在庫は戻りますが、納品書(売上)データは別途削除が必要です。\\n続行しますか？'\n        )\n      )\n        return;\n    }\n\n    const res = await deleteMovement(id);\n    if (res.success) {\n      alert('取り消しました');\n      loadHistory(); // リロード\n    } else {\n      alert('エラー: ' + res.message);\n    }\n  };\n\n  // 表示名変換ヘルパー\n  const getTypeLabel = (type: string) => {\n    switch (type) {\n      case 'receiving':\n        return (\n          <span className=\"bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded text-xs\">\n            受入\n          </span>\n        );\n      case 'production_raw':\n        return (\n          <span className=\"bg-gray-100 text-gray-800 px-2 py-0.5 rounded text-xs\">\n            消費\n          </span>\n        );\n      case 'production_finished':\n        return (\n          <span className=\"bg-blue-100 text-blue-800 px-2 py-0.5 rounded text-xs\">\n            完成\n          </span>\n        );\n      case 'production_defective':\n        return (\n          <span className=\"bg-red-100 text-red-800 px-2 py-0.5 rounded text-xs\">\n            不良\n          </span>\n        );\n      case 'shipping':\n        return (\n          <span className=\"bg-green-100 text-green-800 px-2 py-0.5 rounded text-xs\">\n            出荷\n          </span>\n        );\n      case 'repair':\n        return (\n          <span className=\"bg-blue-50 text-blue-600 px-2 py-0.5 rounded text-xs border border-blue-200\">\n            手直し\n          </span>\n        );\n      case 'return_defective':\n        return (\n          <span className=\"bg-gray-100 text-gray-500 px-2 py-0.5 rounded text-xs border border-gray-300\">\n            返却\n          </span>\n        );\n      default:\n        return type;\n    }\n  };\n\n  return (\n    <div className=\"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4\">\n      <div className=\"bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[80vh] flex flex-col\">\n        <div className=\"p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-lg\">\n          <h3 className=\"font-bold text-gray-800\">履歴・修正: {productName}</h3>\n          <button\n            onClick={onClose}\n            className=\"text-2xl text-gray-400 hover:text-gray-600\"\n          >\n            &times;\n          </button>\n        </div>\n\n        <div className=\"flex-1 overflow-y-auto p-4\">\n          {isLoading ? (\n            <div className=\"text-center py-8 text-gray-500\">読み込み中...</div>\n          ) : history.length === 0 ? (\n            <div className=\"text-center py-8 text-gray-500\">\n              履歴がありません\n            </div>\n          ) : (\n            <table className=\"min-w-full text-sm\">\n              <thead className=\"bg-gray-50 sticky top-0\">\n                <tr>\n                  <th className=\"px-4 py-2 text-left text-gray-500\">日時</th>\n                  <th className=\"px-4 py-2 text-left text-gray-500\">操作</th>\n                  <th className=\"px-4 py-2 text-right text-gray-500\">数量</th>\n                  <th className=\"px-4 py-2 text-left text-gray-500\">\n                    詳細・理由\n                  </th>\n                  <th className=\"px-4 py-2 text-center text-gray-500\">取消</th>\n                </tr>\n              </thead>\n              <tbody className=\"divide-y divide-gray-100\">\n                {history.map((h) => (\n                  <tr key={h.id}>\n                    <td className=\"px-4 py-3 text-gray-600\">\n                      {new Date(h.created_at).toLocaleString('ja-JP', {\n                        month: 'numeric',\n                        day: 'numeric',\n                        hour: '2-digit',\n                        minute: '2-digit',\n                      })}\n                    </td>\n                    <td className=\"px-4 py-3\">\n                      {getTypeLabel(h.movement_type)}\n                    </td>\n                    <td\n                      className={`px-4 py-3 text-right font-bold ${h.quantity_change > 0 ? 'text-blue-600' : 'text-red-600'}`}\n                    >\n                      {h.quantity_change > 0 ? '+' : ''}\n                      {h.quantity_change}\n                    </td>\n                    <td className=\"px-4 py-3 text-gray-500 text-xs\">\n                      {h.reason && <div>{h.reason}</div>}\n                      {h.defect_reason && (\n                        <div className=\"text-red-500\">{h.defect_reason}</div>\n                      )}\n                      {h.due_date && <div>納期: {h.due_date}</div>}\n                    </td>\n                    <td className=\"px-4 py-3 text-center\">\n                      <button\n                        onClick={() => handleDelete(h.id, h.movement_type)}\n                        className=\"text-gray-400 hover:text-red-600\"\n                        title=\"この操作を取り消す\"\n                      >\n                        🗑️\n                      </button>\n                    </td>\n                  </tr>\n                ))}\n              </tbody>\n            </table>\n          )}\n        </div>\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hibino\\otsudenki-portal\\src\\app\\(main)\\inventory\\operation-panel.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":466,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":466,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15229,15232],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15229,15232],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":469,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":469,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15426,15429],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15426,15429],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":763,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":763,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[25534,25537],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[25534,25537],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\hibino\\otsudenki-portal\\src\\app\\(main)\\inventory\\operation-panel.tsx:776:5\n  774 |   };\n  775 |   useEffect(() => {\n> 776 |     loadHistory();\n      |     ^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  777 |   }, []);\n  778 |\n  779 |   const toggleSelect = (id: string) => {","line":776,"column":5,"nodeType":null,"endLine":776,"endColumn":16}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useState, useEffect } from 'react';\nimport {\n  registerReceiving,\n  registerProduction,\n  registerShipment,\n  registerDefectiveProcessing,\n  getGlobalHistory,\n  bulkDeleteMovements,\n} from './actions';\nimport {\n  getRawStockProductsByPartner,\n  getDefectiveProductsByPartner,\n  getRecentShipments,\n  getProductsByPartner,\n} from './actions';\n\n// 型定義\ntype RawProduct = Awaited<\n  ReturnType<typeof getRawStockProductsByPartner>\n>[number];\ntype DefectiveProduct = Awaited<\n  ReturnType<typeof getDefectiveProductsByPartner>\n>[number];\n\nexport default function OperationPanel({\n  partnerId,\n  rawProducts,\n  defectiveProducts,\n}: {\n  partnerId: string;\n  rawProducts: RawProduct[];\n  defectiveProducts: DefectiveProduct[];\n}) {\n  const [activeTab, setActiveTab] = useState('receiving');\n\n  // タブ切り替えスタイル\n  const tabClass = (id: string) =>\n    `px-4 py-2 text-sm font-bold rounded-t-lg transition-colors ${activeTab === id ? 'bg-white text-blue-600 border-t-2 border-blue-600 shadow-sm' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'}`;\n\n  return (\n    <div className=\"space-y-6\">\n      {/* タブヘッダー */}\n      <div className=\"flex border-b border-gray-200 overflow-x-auto\">\n        <button\n          onClick={() => setActiveTab('receiving')}\n          className={tabClass('receiving')}\n        >\n          1. 部材受入\n        </button>\n        <button\n          onClick={() => setActiveTab('production')}\n          className={tabClass('production')}\n        >\n          2. 加工実績\n        </button>\n        <button\n          onClick={() => setActiveTab('shipment')}\n          className={tabClass('shipment')}\n        >\n          3. 出荷登録\n        </button>\n        <button\n          onClick={() => setActiveTab('defective')}\n          className={tabClass('defective')}\n        >\n          4. 不良品処理\n        </button>\n        <button\n          onClick={() => setActiveTab('history')}\n          className={tabClass('history')}\n        >\n          5. 履歴・取消\n        </button>\n      </div>\n\n      <div className=\"bg-white p-6 rounded-b-lg border border-gray-200 shadow-sm min-h-[400px]\">\n        {activeTab === 'receiving' && <ReceivingTab products={rawProducts} />}\n        {activeTab === 'production' && <ProductionTab products={rawProducts} />}\n        {activeTab === 'shipment' && <ShipmentTab partnerId={partnerId} />}\n        {activeTab === 'defective' && (\n          <DefectiveTab products={defectiveProducts} />\n        )}\n        {activeTab === 'history' && <HistoryTable />}\n      </div>\n    </div>\n  );\n}\n\n// ============================================================================\n// 1. 受入登録タブ\n// ============================================================================\nfunction ReceivingTab({ products }: { products: RawProduct[] }) {\n  const [inputs, setInputs] = useState<\n    Record<number, { qty: string; date: string }>\n  >({});\n  const [isSubmitting, setIsSubmitting] = useState(false);\n\n  const handleChange = (id: number, field: 'qty' | 'date', value: string) => {\n    setInputs((prev) => {\n      // ★修正: 二重定義エラー回避のため、初期値を外に出す\n      const current = prev[id] || { qty: '', date: '' };\n      return { ...prev, [id]: { ...current, [field]: value } };\n    });\n  };\n\n  const handleRegister = async (p: RawProduct) => {\n    const input = inputs[p.id];\n    if (!input?.qty) return alert('数量を入力してください');\n    if (confirm(`${p.name} を ${input.qty}個 受入登録しますか？`)) {\n      setIsSubmitting(true);\n      const res = await registerReceiving({\n        productId: p.id,\n        quantity: Number(input.qty),\n        dueDate: input.date || '', // 納期は任意\n      });\n      alert(res.message);\n      if (res.success)\n        setInputs((prev) => ({ ...prev, [p.id]: { qty: '', date: '' } }));\n      setIsSubmitting(false);\n    }\n  };\n\n  return (\n    <div className=\"space-y-4\">\n      <h3 className=\"font-bold text-gray-700 border-l-4 border-yellow-400 pl-3\">\n        生地・部材の受入\n      </h3>\n      {products.length === 0 ? (\n        <p className=\"text-gray-400 py-4\">対象製品がありません</p>\n      ) : (\n        <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n          {products.map((p) => (\n            <div\n              key={p.id}\n              className=\"border p-4 rounded bg-gray-50 hover:bg-white transition-colors\"\n            >\n              <div className=\"font-bold text-lg mb-1\">{p.name}</div>\n              <div className=\"text-xs text-gray-500 mb-2\">\n                {p.product_code} {p.color}\n              </div>\n              <div className=\"flex justify-between text-sm mb-3\">\n                <span>\n                  現在庫:{' '}\n                  <span className=\"font-bold\">\n                    {p.stock_raw.toLocaleString()}\n                  </span>\n                </span>\n              </div>\n              <div className=\"space-y-2\">\n                <input\n                  type=\"number\"\n                  placeholder=\"受入数量\"\n                  className=\"w-full border p-2 rounded\"\n                  value={inputs[p.id]?.qty || ''}\n                  onChange={(e) => handleChange(p.id, 'qty', e.target.value)}\n                />\n                <input\n                  type=\"date\"\n                  className=\"w-full border p-2 rounded text-sm text-gray-500\"\n                  value={inputs[p.id]?.date || ''}\n                  onChange={(e) => handleChange(p.id, 'date', e.target.value)}\n                />\n                <button\n                  onClick={() => handleRegister(p)}\n                  disabled={isSubmitting}\n                  className=\"w-full bg-yellow-500 text-white font-bold py-2 rounded hover:bg-yellow-600 disabled:opacity-50\"\n                >\n                  受入登録\n                </button>\n              </div>\n              {/* 直近の入荷履歴を表示 */}\n              {p.arrivals && p.arrivals.length > 0 && (\n                <div className=\"mt-3 pt-3 border-t border-gray-200\">\n                  <p className=\"text-xs font-bold text-gray-400 mb-1\">\n                    直近の入荷\n                  </p>\n                  <ul className=\"text-xs text-gray-600 space-y-1\">\n                    {p.arrivals.map((log, i) => (\n                      <li key={i}>・{log.label}</li>\n                    ))}\n                  </ul>\n                </div>\n              )}\n            </div>\n          ))}\n        </div>\n      )}\n    </div>\n  );\n}\n\n// ============================================================================\n// 2. 加工実績タブ\n// ============================================================================\ntype ProdInput = {\n  finished: string;\n  rawUsed: string;\n  defective: string;\n  defects: Record<string, number>;\n  sourceDate: string;\n};\n\nfunction ProductionTab({ products }: { products: RawProduct[] }) {\n  const [inputs, setInputs] = useState<Record<number, ProdInput>>({});\n  const [isSubmitting, setIsSubmitting] = useState(false);\n\n  const handleChange = (id: number, field: keyof ProdInput, value: string) => {\n    setInputs((prev) => {\n      // ★修正: 初期値を外に出してスッキリさせる\n      const current = prev[id] || {\n        finished: '',\n        rawUsed: '',\n        defective: '',\n        defects: {},\n        sourceDate: '',\n      };\n      return { ...prev, [id]: { ...current, [field]: value } };\n    });\n  };\n\n  const handleDefectsSave = (\n    productId: number,\n    newDefects: Record<string, number>\n  ) => {\n    setInputs((prev) => {\n      const current = prev[productId] || {\n        finished: '',\n        rawUsed: '',\n        defective: '',\n        defects: {},\n        sourceDate: '',\n      };\n      // 不良数の合計を計算して defective にセット\n      const totalDefective = Object.values(newDefects).reduce(\n        (a, b) => a + b,\n        0\n      );\n      return {\n        ...prev,\n        [productId]: {\n          ...current,\n          defects: newDefects,\n          defective: totalDefective > 0 ? totalDefective.toString() : '',\n        },\n      };\n    });\n  };\n\n  const handleRegister = async (p: RawProduct) => {\n    const inp = inputs[p.id] || {};\n    const finished = Number(inp.finished || 0);\n    const defective = Number(inp.defective || 0);\n    const rawUsed = Number(inp.rawUsed) || finished + defective; // 入力なければ自動計算\n\n    if (finished + defective === 0)\n      return alert('完成数または不良数を入力してください');\n\n    // 不良理由のテキスト化\n    let defectReason = '';\n    if (inp.defects && Object.keys(inp.defects).length > 0) {\n      defectReason = Object.entries(inp.defects)\n        .map(([reason, count]) => `${reason}:${count}`)\n        .join(', ');\n    }\n\n    if (\n      confirm(\n        `以下の内容で登録しますか？\\n\\n・製品: ${p.name}\\n・良品完成: ${finished}個\\n・不良発生: ${defective}個\\n・生地消費: ${rawUsed}個\\n${inp.sourceDate ? `・入荷日指定: ${inp.sourceDate}` : ''}`\n      )\n    ) {\n      setIsSubmitting(true);\n      const res = await registerProduction({\n        productId: p.id,\n        rawUsed,\n        finished,\n        defective,\n        defectReason,\n        sourceDate: inp.sourceDate,\n      });\n      alert(res.message);\n      if (res.success)\n        setInputs((prev) => ({\n          ...prev,\n          [p.id]: {\n            finished: '',\n            rawUsed: '',\n            defective: '',\n            defects: {},\n            sourceDate: '',\n          },\n        }));\n      setIsSubmitting(false);\n    }\n  };\n\n  return (\n    <div className=\"space-y-4\">\n      <h3 className=\"font-bold text-gray-700 border-l-4 border-blue-500 pl-3\">\n        加工実績の登録\n      </h3>\n      {products.length === 0 ? (\n        <p className=\"text-gray-400 py-4\">対象製品がありません</p>\n      ) : (\n        <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n          {products.map((p) => {\n            const inp = inputs[p.id] || {};\n            return (\n              <div\n                key={p.id}\n                className=\"border p-4 rounded bg-gray-50 hover:bg-white transition-colors relative\"\n              >\n                <div className=\"font-bold text-lg mb-1\">{p.name}</div>\n                <div className=\"text-xs text-gray-500 mb-3\">\n                  {p.product_code} {p.color}\n                </div>\n\n                {/* 入荷日選択プルダウン */}\n                {p.arrivals && p.arrivals.length > 0 && (\n                  <div className=\"mb-3\">\n                    <select\n                      className=\"w-full text-xs border rounded p-1 bg-white text-gray-700\"\n                      value={inp.sourceDate || ''}\n                      onChange={(e) =>\n                        handleChange(p.id, 'sourceDate', e.target.value)\n                      }\n                    >\n                      <option value=\"\">いつの入荷分を使用？ (指定なし)</option>\n                      {p.arrivals.map((a, idx) => (\n                        <option key={idx} value={a.value}>\n                          {a.label}\n                        </option>\n                      ))}\n                    </select>\n                  </div>\n                )}\n\n                <div className=\"space-y-3\">\n                  <div className=\"flex items-center gap-2\">\n                    <span className=\"text-sm font-bold w-12 text-blue-600\">\n                      完成\n                    </span>\n                    <input\n                      type=\"number\"\n                      placeholder=\"0\"\n                      className=\"flex-1 border p-2 rounded font-bold\"\n                      value={inp.finished || ''}\n                      onChange={(e) =>\n                        handleChange(p.id, 'finished', e.target.value)\n                      }\n                    />\n                  </div>\n\n                  {/* 不良入力コンポーネント */}\n                  <DefectInputRow\n                    productId={p.id}\n                    currentDefects={inp.defects || {}}\n                    onSave={handleDefectsSave}\n                  />\n\n                  <div className=\"flex items-center gap-2 pt-2 border-t border-gray-200\">\n                    <span className=\"text-xs font-bold w-12 text-gray-500\">\n                      消費\n                    </span>\n                    <input\n                      type=\"number\"\n                      placeholder=\"自動\"\n                      className=\"flex-1 border p-1 rounded text-sm bg-gray-100\"\n                      value={inp.rawUsed || ''}\n                      onChange={(e) =>\n                        handleChange(p.id, 'rawUsed', e.target.value)\n                      }\n                    />\n                  </div>\n\n                  <button\n                    onClick={() => handleRegister(p)}\n                    disabled={isSubmitting}\n                    className=\"w-full bg-blue-600 text-white font-bold py-2 rounded hover:bg-blue-700 disabled:opacity-50 mt-2\"\n                  >\n                    実績登録\n                  </button>\n                </div>\n              </div>\n            );\n          })}\n        </div>\n      )}\n    </div>\n  );\n}\n\n// サブコンポーネント: 不良入力行 (ポップアップ対応)\nfunction DefectInputRow({\n  productId,\n  currentDefects,\n  onSave,\n}: {\n  productId: number;\n  currentDefects: Record<string, number>;\n  onSave: (pid: number, defects: Record<string, number>) => void;\n}) {\n  const [isOpen, setIsOpen] = useState(false);\n  const total = Object.values(currentDefects).reduce((a, b) => a + b, 0);\n\n  // 不良理由マスタ\n  const reasons = ['打痕', '塗装不良', 'メッキ不良', '寸法NG', 'その他'];\n\n  const handleReasonChange = (reason: string, val: string) => {\n    const num = Number(val);\n    const next = { ...currentDefects };\n    if (num > 0) next[reason] = num;\n    else delete next[reason];\n    onSave(productId, next);\n  };\n\n  return (\n    <div className=\"relative\">\n      <div className=\"flex items-center gap-2\">\n        <span className=\"text-sm font-bold w-12 text-red-500\">不良</span>\n        <div\n          onClick={() => setIsOpen(!isOpen)}\n          className=\"flex-1 border p-2 rounded bg-red-50 text-red-600 cursor-pointer flex justify-between items-center hover:bg-red-100\"\n        >\n          <span className=\"font-bold\">{total > 0 ? total : ''}</span>\n          <span className=\"text-xs\">▼ 詳細</span>\n        </div>\n      </div>\n\n      {isOpen && (\n        <div className=\"absolute top-full left-0 z-10 w-64 bg-white border border-gray-300 shadow-xl rounded-lg p-3 mt-1\">\n          <div className=\"flex justify-between items-center mb-2 pb-2 border-b\">\n            <span className=\"font-bold text-sm text-gray-700\">不良内訳</span>\n            <button\n              onClick={() => setIsOpen(false)}\n              className=\"text-gray-400 hover:text-gray-600\"\n            >\n              ✕\n            </button>\n          </div>\n          <div className=\"space-y-2\">\n            {reasons.map((r) => (\n              <div key={r} className=\"flex items-center justify-between\">\n                <span className=\"text-sm text-gray-600\">{r}</span>\n                <input\n                  type=\"number\"\n                  className=\"w-16 border rounded p-1 text-right text-sm\"\n                  placeholder=\"0\"\n                  value={currentDefects[r] || ''}\n                  onChange={(e) => handleReasonChange(r, e.target.value)}\n                />\n              </div>\n            ))}\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n\n// ============================================================================\n// 3. 出荷登録タブ\n// ============================================================================\nfunction ShipmentTab({ partnerId }: { partnerId: string }) {\n  const [products, setProducts] = useState<any[]>([]);\n  const [inputs, setInputs] = useState<Record<number, string>>({});\n  const [date, setDate] = useState(new Date().toISOString().split('T')[0]);\n  const [history, setHistory] = useState<any[]>([]);\n  const [isSubmitting, setIsSubmitting] = useState(false);\n\n  // 初期ロード\n  useEffect(() => {\n    const load = async () => {\n      const [pData, hData] = await Promise.all([\n        getProductsByPartner(partnerId),\n        getRecentShipments(partnerId),\n      ]);\n      setProducts(pData || []);\n      setHistory(hData || []);\n    };\n    load();\n  }, [partnerId]);\n\n  const handleChange = (id: number, val: string) => {\n    setInputs((prev) => ({ ...prev, [id]: val }));\n  };\n\n  const handleRegister = async () => {\n    const items = Object.entries(inputs)\n      .map(([pid, qty]) => ({ productId: Number(pid), quantity: Number(qty) }))\n      .filter((i) => i.quantity > 0);\n\n    if (items.length === 0) return alert('出荷数を入力してください');\n\n    if (confirm(`${items.length}品目の出荷を登録しますか？\\n出荷日: ${date}`)) {\n      setIsSubmitting(true);\n      const res = await registerShipment({\n        partnerId,\n        shipmentDate: date,\n        items,\n      });\n\n      if (res.success) {\n        alert(res.message);\n        setInputs({});\n        // 履歴更新\n        const hData = await getRecentShipments(partnerId);\n        setHistory(hData || []);\n      } else {\n        alert(res.message);\n      }\n      setIsSubmitting(false);\n    }\n  };\n\n  return (\n    <div className=\"flex gap-6\">\n      <div className=\"flex-1 space-y-4\">\n        <h3 className=\"font-bold text-gray-700 border-l-4 border-green-500 pl-3\">\n          出荷データの登録\n        </h3>\n\n        <div className=\"bg-gray-50 p-4 rounded flex items-center gap-4\">\n          <label className=\"font-bold text-gray-700\">出荷日:</label>\n          <input\n            type=\"date\"\n            value={date}\n            onChange={(e) => setDate(e.target.value)}\n            className=\"border p-2 rounded\"\n          />\n        </div>\n\n        {products.length === 0 ? (\n          <p className=\"text-gray-400\">登録された製品がありません</p>\n        ) : (\n          <div className=\"bg-white border rounded shadow-sm overflow-hidden\">\n            <table className=\"min-w-full divide-y divide-gray-200\">\n              <thead className=\"bg-gray-100\">\n                <tr>\n                  <th className=\"px-4 py-2 text-left text-xs font-bold text-gray-500\">\n                    製品コード\n                  </th>\n                  <th className=\"px-4 py-2 text-left text-xs font-bold text-gray-500\">\n                    製品名\n                  </th>\n                  <th className=\"px-4 py-2 text-left text-xs font-bold text-gray-500\">\n                    色\n                  </th>\n                  <th className=\"px-4 py-2 text-right text-xs font-bold text-gray-500 w-32\">\n                    出荷数量\n                  </th>\n                </tr>\n              </thead>\n              <tbody className=\"divide-y divide-gray-200\">\n                {products.map((p) => (\n                  <tr key={p.id} className={inputs[p.id] ? 'bg-green-50' : ''}>\n                    <td className=\"px-4 py-3 text-sm font-mono text-gray-600\">\n                      {p.product_code}\n                    </td>\n                    <td className=\"px-4 py-3 text-sm font-bold text-gray-800\">\n                      {p.name}\n                    </td>\n                    <td className=\"px-4 py-3 text-sm text-gray-500\">\n                      {p.color}\n                    </td>\n                    <td className=\"px-4 py-2\">\n                      <input\n                        type=\"number\"\n                        className=\"w-full border p-1 rounded text-right font-bold focus:ring-2 focus:ring-green-500 focus:outline-none\"\n                        placeholder=\"0\"\n                        value={inputs[p.id] || ''}\n                        onChange={(e) => handleChange(p.id, e.target.value)}\n                      />\n                    </td>\n                  </tr>\n                ))}\n              </tbody>\n            </table>\n          </div>\n        )}\n\n        <div className=\"pt-4 text-right\">\n          <button\n            onClick={handleRegister}\n            disabled={isSubmitting}\n            className=\"bg-green-600 text-white px-8 py-3 rounded-lg font-bold shadow hover:bg-green-700 disabled:opacity-50\"\n          >\n            出荷登録する\n          </button>\n        </div>\n      </div>\n\n      {/* 右側サイド: 直近の出荷履歴リスト */}\n      <div className=\"w-64 flex-shrink-0 border-l pl-6 hidden lg:block\">\n        <h4 className=\"font-bold text-gray-500 mb-4 text-sm\">\n          最近の出荷リスト\n        </h4>\n        <div className=\"space-y-3\">\n          {history.length === 0 && (\n            <p className=\"text-xs text-gray-400\">履歴なし</p>\n          )}\n          {history.map((h) => (\n            <div key={h.id} className=\"border p-3 rounded bg-gray-50 text-sm\">\n              <div className=\"flex justify-between text-gray-500 text-xs mb-1\">\n                <span>{new Date(h.shipment_date).toLocaleDateString()}</span>\n                <a\n                  href={`/shipments/${h.id}/print`}\n                  target=\"_blank\"\n                  className=\"text-blue-600 hover:underline\"\n                >\n                  印刷\n                </a>\n              </div>\n              <div className=\"font-bold text-gray-800\">\n                ¥{h.total_amount.toLocaleString()}\n              </div>\n            </div>\n          ))}\n        </div>\n      </div>\n    </div>\n  );\n}\n\n// ============================================================================\n// 4. 不良品処理タブ\n// ============================================================================\nfunction DefectiveTab({ products }: { products: DefectiveProduct[] }) {\n  const [inputs, setInputs] = useState<\n    Record<number, { rework: string; return: string }>\n  >({});\n  const [isSubmitting, setIsSubmitting] = useState(false);\n\n  const handleChange = (\n    id: number,\n    field: 'rework' | 'return',\n    value: string\n  ) => {\n    setInputs((prev) => {\n      // ★修正: 初期値を外に出す\n      const current = prev[id] || { rework: '', return: '' };\n      return { ...prev, [id]: { ...current, [field]: value } };\n    });\n  };\n\n  const handleRegister = async (p: DefectiveProduct) => {\n    const inp = inputs[p.id] || { rework: '0', return: '0' };\n    const rework = Number(inp.rework || 0);\n    const ret = Number(inp.return || 0);\n\n    if (rework + ret === 0) return alert('数量を入力してください');\n    if (\n      confirm(\n        `処理を実行しますか？\\n\\n・手直し良品化: ${rework}個\\n・不良品返却: ${ret}個`\n      )\n    ) {\n      setIsSubmitting(true);\n      const res = await registerDefectiveProcessing({\n        productId: p.id,\n        reworkQty: rework,\n        returnQty: ret,\n      });\n      alert(res.message);\n      if (res.success)\n        setInputs((prev) => ({ ...prev, [p.id]: { rework: '', return: '' } }));\n      setIsSubmitting(false);\n    }\n  };\n\n  return (\n    <div className=\"space-y-4\">\n      <h3 className=\"font-bold text-gray-700 border-l-4 border-red-500 pl-3\">\n        不良在庫の処理\n      </h3>\n      <p className=\"text-sm text-gray-500\">\n        発生した不良品について、「手直しして良品にする」か「客先へ返却(廃棄)する」かを登録します。\n      </p>\n\n      {products.length === 0 ? (\n        <div className=\"p-8 text-center bg-gray-50 rounded text-gray-400\">\n          現在、不良在庫はありません\n        </div>\n      ) : (\n        <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n          {products.map((p) => (\n            <div\n              key={p.id}\n              className=\"border p-4 rounded bg-red-50 border-red-100\"\n            >\n              <div className=\"font-bold text-lg text-gray-800\">{p.name}</div>\n              <div className=\"text-xs text-gray-500 mb-2\">{p.product_code}</div>\n              <div className=\"mb-4 text-center bg-white rounded p-2 border border-red-200\">\n                <span className=\"text-xs text-gray-500 block\">不良在庫</span>\n                <span className=\"text-xl font-bold text-red-600\">\n                  {p.stock_defective}\n                </span>\n              </div>\n\n              {/* 直近の不良理由 */}\n              {p.recent_defects.length > 0 && (\n                <div className=\"mb-3 text-xs bg-white/50 p-2 rounded\">\n                  <p className=\"font-bold text-gray-500 mb-1\">\n                    最近の不良理由:\n                  </p>\n                  {p.recent_defects.map((d, i) => (\n                    <div key={i} className=\"text-gray-600\">\n                      ・{d.reason} ({d.date})\n                    </div>\n                  ))}\n                </div>\n              )}\n\n              <div className=\"space-y-3\">\n                <div className=\"flex items-center gap-2\">\n                  <span className=\"text-xs font-bold w-16 text-blue-600\">\n                    手直しOK\n                  </span>\n                  <input\n                    type=\"number\"\n                    placeholder=\"良品へ\"\n                    className=\"flex-1 border p-1 rounded\"\n                    value={inputs[p.id]?.rework || ''}\n                    onChange={(e) =>\n                      handleChange(p.id, 'rework', e.target.value)\n                    }\n                  />\n                </div>\n                <div className=\"flex items-center gap-2\">\n                  <span className=\"text-xs font-bold w-16 text-gray-500\">\n                    返却/廃棄\n                  </span>\n                  <input\n                    type=\"number\"\n                    placeholder=\"在庫減\"\n                    className=\"flex-1 border p-1 rounded\"\n                    value={inputs[p.id]?.return || ''}\n                    onChange={(e) =>\n                      handleChange(p.id, 'return', e.target.value)\n                    }\n                  />\n                </div>\n                <button\n                  onClick={() => handleRegister(p)}\n                  disabled={isSubmitting}\n                  className=\"w-full bg-red-500 text-white font-bold py-2 rounded hover:bg-red-600 disabled:opacity-50 text-sm\"\n                >\n                  処理登録\n                </button>\n              </div>\n            </div>\n          ))}\n        </div>\n      )}\n    </div>\n  );\n}\n\n// ============================================================================\n// 5. 履歴・一括削除テーブル\n// ============================================================================\nfunction HistoryTable() {\n  const [history, setHistory] = useState<any[]>([]);\n  const [selectedIds, setSelectedIds] = useState<Set<string>>(new Set());\n  const [isLoading, setIsLoading] = useState(false);\n  const [isDeleting, setIsDeleting] = useState(false);\n\n  const loadHistory = async () => {\n    setIsLoading(true);\n    const data = await getGlobalHistory();\n    setHistory(data);\n    setSelectedIds(new Set());\n    setIsLoading(false);\n  };\n  useEffect(() => {\n    loadHistory();\n  }, []);\n\n  const toggleSelect = (id: string) => {\n    const newSet = new Set(selectedIds);\n    if (newSet.has(id)) newSet.delete(id);\n    else newSet.add(id);\n    setSelectedIds(newSet);\n  };\n  const toggleAll = () => {\n    if (selectedIds.size === history.length) setSelectedIds(new Set());\n    else setSelectedIds(new Set(history.map((h) => h.id)));\n  };\n\n  const handleUndo = async () => {\n    if (selectedIds.size === 0) return;\n    if (\n      !confirm(\n        `選択した ${selectedIds.size} 件の操作を「取り消し」ますか？\\n\\n【注意】\\n在庫数が操作前の状態に戻ります。\\n(例: 受入を取り消すと在庫が減ります)`\n      )\n    )\n      return;\n    setIsDeleting(true);\n    const res = await bulkDeleteMovements(Array.from(selectedIds));\n    setIsDeleting(false);\n    alert(res.message);\n    loadHistory();\n  };\n\n  const getTypeLabel = (type: string) => {\n    switch (type) {\n      case 'receiving':\n        return (\n          <span className=\"bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded text-xs font-bold\">\n            受入\n          </span>\n        );\n      case 'production_raw':\n        return (\n          <span className=\"bg-gray-100 text-gray-800 px-2 py-0.5 rounded text-xs\">\n            消費\n          </span>\n        );\n      case 'production_finished':\n        return (\n          <span className=\"bg-blue-100 text-blue-800 px-2 py-0.5 rounded text-xs font-bold\">\n            完成\n          </span>\n        );\n      case 'production_defective':\n        return (\n          <span className=\"bg-red-100 text-red-800 px-2 py-0.5 rounded text-xs\">\n            不良\n          </span>\n        );\n      case 'shipping':\n        return (\n          <span className=\"bg-green-100 text-green-800 px-2 py-0.5 rounded text-xs font-bold\">\n            出荷\n          </span>\n        );\n      case 'repair':\n        return (\n          <span className=\"bg-blue-50 text-blue-600 px-2 py-0.5 rounded text-xs border border-blue-200\">\n            手直し\n          </span>\n        );\n      case 'return_defective':\n        return (\n          <span className=\"bg-gray-100 text-gray-500 px-2 py-0.5 rounded text-xs border border-gray-300\">\n            返却\n          </span>\n        );\n      case 'shipping_cancel':\n        return (\n          <span className=\"bg-gray-600 text-white px-2 py-0.5 rounded text-xs font-bold\">\n            出荷取消\n          </span>\n        );\n      default:\n        return type;\n    }\n  };\n\n  return (\n    <div className=\"space-y-4\">\n      <div className=\"flex justify-between items-center bg-gray-50 p-4 rounded-md border border-gray-200\">\n        <div>\n          <h3 className=\"font-bold text-gray-800\">操作履歴の管理</h3>\n          <p className=\"text-xs text-gray-500 mt-1\">\n            操作を選んで「一括取り消し」ボタンを押すと、在庫が元の状態に戻ります。\n          </p>\n        </div>\n        <div className=\"flex gap-3 items-center\">\n          <button\n            onClick={loadHistory}\n            className=\"text-sm text-gray-500 hover:text-indigo-600 underline mr-2\"\n          >\n            再読み込み\n          </button>\n          <button\n            onClick={handleUndo}\n            disabled={selectedIds.size === 0 || isDeleting}\n            className={`px-4 py-2 rounded-md font-bold text-white shadow-sm text-sm ${selectedIds.size > 0 ? 'bg-red-500 hover:bg-red-600' : 'bg-gray-300 cursor-not-allowed'}`}\n          >\n            一括取り消し (在庫戻す)\n          </button>\n        </div>\n      </div>\n\n      <div className=\"border border-gray-200 rounded-lg overflow-hidden bg-white shadow\">\n        {isLoading ? (\n          <div className=\"p-12 text-center text-gray-500\">読み込み中...</div>\n        ) : history.length === 0 ? (\n          <div className=\"p-12 text-center text-gray-500\">履歴なし</div>\n        ) : (\n          <div className=\"overflow-x-auto\">\n            <table className=\"min-w-full divide-y divide-gray-200\">\n              <thead className=\"bg-gray-50\">\n                <tr>\n                  <th className=\"px-4 py-3 w-12\">\n                    <input\n                      type=\"checkbox\"\n                      className=\"rounded border-gray-300\"\n                      checked={\n                        selectedIds.size === history.length &&\n                        history.length > 0\n                      }\n                      onChange={toggleAll}\n                    />\n                  </th>\n                  <th className=\"px-4 py-3 text-left text-xs font-medium text-gray-500\">\n                    日時\n                  </th>\n                  <th className=\"px-4 py-3 text-left text-xs font-medium text-gray-500\">\n                    種類\n                  </th>\n                  <th className=\"px-4 py-3 text-left text-xs font-medium text-gray-500\">\n                    取引先 / 品名\n                  </th>\n                  <th className=\"px-4 py-3 text-right text-xs font-medium text-gray-500\">\n                    数量\n                  </th>\n                </tr>\n              </thead>\n              <tbody className=\"divide-y divide-gray-200 text-sm\">\n                {history.map((h) => {\n                  const isSelected = selectedIds.has(h.id);\n                  return (\n                    <tr\n                      key={h.id}\n                      className={isSelected ? 'bg-blue-50' : 'hover:bg-gray-50'}\n                    >\n                      <td className=\"px-4 py-3 text-center\">\n                        <input\n                          type=\"checkbox\"\n                          className=\"rounded border-gray-300\"\n                          checked={isSelected}\n                          onChange={() => toggleSelect(h.id)}\n                        />\n                      </td>\n                      <td className=\"px-4 py-3 text-xs text-gray-500\">\n                        {new Date(h.created_at).toLocaleString('ja-JP')}\n                      </td>\n                      <td className=\"px-4 py-3\">\n                        {getTypeLabel(h.movement_type)}\n                      </td>\n                      <td className=\"px-4 py-3\">\n                        <div className=\"text-xs text-gray-500\">\n                          {h.products?.partners?.name}\n                        </div>\n                        <div className=\"font-bold text-gray-700\">\n                          {h.products?.name}\n                        </div>\n                        {h.reason && (\n                          <div className=\"text-xs text-gray-400\">\n                            {h.reason}\n                          </div>\n                        )}\n                      </td>\n                      <td\n                        className={`px-4 py-3 text-right font-bold ${h.quantity_change > 0 ? 'text-blue-600' : 'text-red-600'}`}\n                      >\n                        {h.quantity_change > 0 ? '+' : ''}\n                        {h.quantity_change}\n                      </td>\n                    </tr>\n                  );\n                })}\n              </tbody>\n            </table>\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hibino\\otsudenki-portal\\src\\app\\(main)\\inventory\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":21,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":21,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[612,615],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[612,615],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":22,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":22,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[673,676],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[673,676],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":23,"column":62,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":23,"endColumn":65,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[746,749],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[746,749],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useState, useEffect } from 'react';\nimport { createClient } from '@/utils/supabase/client';\nimport OperationPanel from './operation-panel';\nimport InventoryList from './inventory-list';\nimport {\n  getRawStockProductsByPartner,\n  getDefectiveProductsByPartner,\n  getAllInventory,\n} from './actions';\n\n// 取引先型定義\ntype Partner = { id: string; name: string };\n\nexport default function InventoryPage() {\n  const [partners, setPartners] = useState<Partner[]>([]);\n  const [selectedPartnerId, setSelectedPartnerId] = useState<string>('');\n\n  // 各種データ\n  const [inventory, setInventory] = useState<any[]>([]);\n  const [rawProducts, setRawProducts] = useState<any[]>([]);\n  const [defectiveProducts, setDefectiveProducts] = useState<any[]>([]);\n\n  const [isLoading, setIsLoading] = useState(true);\n\n  // 初期ロード (取引先一覧 ＆ 全在庫)\n  useEffect(() => {\n    const loadInit = async () => {\n      const supabase = createClient();\n\n      // 1. 取引先取得\n      const { data: pData } = await supabase\n        .from('partners')\n        .select('id, name')\n        .order('code');\n      setPartners(pData || []);\n\n      // デフォルトで最初の取引先を選択\n      if (pData && pData.length > 0) {\n        setSelectedPartnerId(pData[0].id);\n      }\n\n      // 2. 在庫一覧取得\n      const invData = await getAllInventory();\n      setInventory(invData);\n\n      setIsLoading(false);\n    };\n    loadInit();\n  }, []);\n\n  // 取引先変更時に、操作パネル用の詳細データを取得\n  useEffect(() => {\n    if (!selectedPartnerId) return;\n\n    const loadDetails = async () => {\n      const [raw, defective] = await Promise.all([\n        getRawStockProductsByPartner(selectedPartnerId),\n        getDefectiveProductsByPartner(selectedPartnerId),\n      ]);\n      setRawProducts(raw);\n      setDefectiveProducts(defective);\n    };\n    loadDetails();\n  }, [selectedPartnerId]);\n\n  // データリロード用ハンドラ (操作パネルでの更新後に呼ぶ)\n  const handleRefresh = async () => {\n    // 在庫一覧を更新\n    const invData = await getAllInventory();\n    setInventory(invData);\n\n    // 操作パネル用データも更新\n    if (selectedPartnerId) {\n      const [raw, defective] = await Promise.all([\n        getRawStockProductsByPartner(selectedPartnerId),\n        getDefectiveProductsByPartner(selectedPartnerId),\n      ]);\n      setRawProducts(raw);\n      setDefectiveProducts(defective);\n    }\n  };\n\n  return (\n    <div className=\"space-y-8\">\n      <div className=\"flex justify-between items-center\">\n        <h1 className=\"text-2xl font-bold text-gray-800\">\n          業務管理 (入出荷・在庫)\n        </h1>\n\n        {/* 取引先切り替えプルダウン */}\n        <div className=\"flex items-center gap-2\">\n          <label className=\"text-sm font-bold text-gray-600\">操作対象:</label>\n          <select\n            className=\"border rounded px-3 py-2 bg-white shadow-sm min-w-[200px]\"\n            value={selectedPartnerId}\n            onChange={(e) => setSelectedPartnerId(e.target.value)}\n          >\n            {partners.map((p) => (\n              <option key={p.id} value={p.id}>\n                {p.name}\n              </option>\n            ))}\n          </select>\n        </div>\n      </div>\n\n      {/* 1. 操作パネル (受入・加工・出荷など) */}\n      <div className=\"bg-white shadow rounded-lg p-6 border border-gray-200\">\n        {!selectedPartnerId ? (\n          <div className=\"text-center text-gray-400 py-8\">\n            取引先を選択してください\n          </div>\n        ) : (\n          <OperationPanel\n            partnerId={selectedPartnerId}\n            rawProducts={rawProducts}\n            defectiveProducts={defectiveProducts}\n            // 操作後に一覧を更新するためにkeyを変えるテクニック、またはリロード関数を渡す設計も可\n            // 今回はシンプルにデータ更新のみ行います\n          />\n        )}\n      </div>\n\n      {/* 2. 在庫一覧リスト (下部) */}\n      <div className=\"space-y-2\">\n        <div className=\"flex justify-between items-end px-2\">\n          <h2 className=\"text-lg font-bold text-gray-700\">最新の在庫状況</h2>\n          <button\n            onClick={handleRefresh}\n            className=\"text-sm text-blue-600 hover:underline\"\n          >\n            情報を更新\n          </button>\n        </div>\n        <div className=\"bg-white shadow rounded-lg p-6 border border-gray-200\">\n          {isLoading ? (\n            <div className=\"text-center py-10 text-gray-500\">読み込み中...</div>\n          ) : (\n            <InventoryList inventory={inventory} />\n          )}\n        </div>\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hibino\\otsudenki-portal\\src\\app\\(main)\\invoices\\actions.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":42,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":42,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1040,1043],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1040,1043],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":147,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":147,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3624,3627],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3624,3627],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use server';\n\nimport { createClient } from '@/utils/supabase/server';\nimport { revalidatePath } from 'next/cache';\n\n// 請求書作成候補の型\nexport type InvoiceCandidate = {\n  partner: { id: string; name: string };\n  shipment_count: number;\n  total_amount_excl_tax: number; // 税抜合計\n};\n\n// 1. 未請求データの検索 (対象選択画面用)\nexport async function getUnbilledSummary(\n  closingDate: number,\n  startDate: string,\n  endDate: string\n) {\n  const supabase = await createClient();\n\n  // 指定期間・締め日の取引先に関連する「未請求(invoice_id is null)」の出荷を取得\n  const { data: shipments } = await supabase\n    .from('shipments')\n    .select(\n      `\n      total_amount,\n      partners!inner ( id, name, closing_date )\n    `\n    )\n    .is('invoice_id', null) // 未請求\n    .eq('partners.closing_date', closingDate) // 締め日一致\n    .gte('shipment_date', startDate)\n    .lte('shipment_date', endDate);\n\n  if (!shipments) return [];\n\n  // 取引先ごとに集計\n  const summaryMap = new Map<string, InvoiceCandidate>();\n\n  shipments.forEach((s) => {\n    // ★修正ポイント: ここで型エラーが出ていたので as any で回避\n    const p = s.partners as any;\n    const pId = p.id;\n\n    if (!summaryMap.has(pId)) {\n      summaryMap.set(pId, {\n        partner: { id: pId, name: p.name },\n        shipment_count: 0,\n        total_amount_excl_tax: 0,\n      });\n    }\n    const current = summaryMap.get(pId)!;\n    current.shipment_count += 1;\n    current.total_amount_excl_tax += s.total_amount;\n  });\n\n  return Array.from(summaryMap.values());\n}\n\n// 2. 特定取引先の未請求出荷データ（詳細）を取得 (確認画面用)\nexport async function getUnbilledShipments(\n  partnerId: string,\n  startDate: string,\n  endDate: string\n) {\n  const supabase = await createClient();\n\n  // 指定期間・指定取引先の未請求出荷を、明細付きで取得\n  const { data: shipments } = await supabase\n    .from('shipments')\n    .select(\n      `\n      id,\n      shipment_date,\n      delivery_note_number,\n      total_amount,\n      shipment_items (\n        id,\n        quantity,\n        unit_price,\n        line_total,\n        products ( name, product_code, color )\n      ),\n      partners ( name )\n    `\n    )\n    .eq('partner_id', partnerId)\n    .is('invoice_id', null) // 未請求\n    .gte('shipment_date', startDate)\n    .lte('shipment_date', endDate)\n    .order('shipment_date', { ascending: true });\n\n  return shipments || [];\n}\n\n// 3. 1件の請求書を作成（確定処理）\nexport async function createSingleInvoice(\n  partnerId: string,\n  periodStart: string,\n  periodEnd: string,\n  totalExclTax: number // 画面で確認した税抜合計\n) {\n  const supabase = await createClient();\n  const {\n    data: { user },\n  } = await supabase.auth.getUser();\n  if (!user) return { success: false, message: '要ログイン' };\n\n  try {\n    // 消費税計算 (10% 端数切り捨て)\n    const subtotal = totalExclTax;\n    const tax = Math.floor(subtotal * 0.1);\n    const total = subtotal + tax;\n\n    // A. 請求書ヘッダー作成\n    const { data: invoice, error: invError } = await supabase\n      .from('invoices')\n      .insert({\n        partner_id: partnerId,\n        period_start: periodStart,\n        period_end: periodEnd,\n        issue_date: new Date().toISOString(), // 発行日は今日\n        subtotal: subtotal,\n        tax_amount: tax,\n        total_amount: total,\n        status: 'confirmed',\n        created_by: user.id,\n      })\n      .select()\n      .single();\n\n    if (invError) throw invError;\n\n    // B. 出荷データに請求書IDを紐付け\n    const { error: shipError } = await supabase\n      .from('shipments')\n      .update({ invoice_id: invoice.id })\n      .eq('partner_id', partnerId)\n      .is('invoice_id', null)\n      .gte('shipment_date', periodStart)\n      .lte('shipment_date', periodEnd);\n\n    if (shipError) throw shipError;\n\n    revalidatePath('/invoices');\n    return { success: true, message: '請求書を作成しました' };\n  } catch (e: any) {\n    console.error(e);\n    return { success: false, message: '作成エラー: ' + e.message };\n  }\n}\n\n// 4. 請求書一覧取得 (一覧画面用)\nexport async function getInvoices() {\n  const supabase = await createClient();\n  const { data } = await supabase\n    .from('invoices')\n    .select(\n      `\n      *,\n      partners ( name )\n    `\n    )\n    .order('created_at', { ascending: false })\n    .limit(50);\n  return data || [];\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hibino\\otsudenki-portal\\src\\app\\(main)\\invoices\\create\\[partnerId]\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":17,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":17,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[577,580],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[577,580],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":29,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":29,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1055,1058],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1055,1058],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":131,"column":57,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":131,"endColumn":60,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4874,4877],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4874,4877],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useState, useEffect } from 'react';\nimport { useRouter, useSearchParams, useParams } from 'next/navigation';\nimport { getUnbilledShipments, createSingleInvoice } from '../../actions';\nimport Link from 'next/link';\n\nexport default function ConfirmInvoicePage() {\n  const params = useParams();\n  const partnerId = params.partnerId as string;\n\n  const router = useRouter();\n  const searchParams = useSearchParams();\n  const start = searchParams.get('start') || '';\n  const end = searchParams.get('end') || '';\n\n  const [shipments, setShipments] = useState<any[]>([]);\n  const [partnerName, setPartnerName] = useState('');\n  const [isLoading, setIsLoading] = useState(true);\n  const [isSubmitting, setIsSubmitting] = useState(false);\n\n  useEffect(() => {\n    if (!partnerId || !start || !end) return;\n    const load = async () => {\n      setIsLoading(true);\n      const data = await getUnbilledShipments(partnerId, start, end);\n      setShipments(data || []);\n      if (data && data.length > 0) {\n        const p = data[0].partners as any;\n        const name = Array.isArray(p) ? p[0]?.name : p?.name;\n        setPartnerName(name || '');\n      }\n      setIsLoading(false);\n    };\n    load();\n  }, [partnerId, start, end]);\n\n  const totalExclTax = shipments.reduce((sum, s) => sum + s.total_amount, 0);\n  const tax = Math.floor(totalExclTax * 0.1);\n  const totalAmount = totalExclTax + tax;\n\n  const handleConfirm = async () => {\n    if (!confirm(`${partnerName} 宛の請求書を確定しますか？`)) return;\n    setIsSubmitting(true);\n    const res = await createSingleInvoice(partnerId, start, end, totalExclTax);\n    if (res.success) {\n      alert(res.message);\n      router.push('/invoices');\n    } else {\n      alert(res.message);\n      setIsSubmitting(false);\n    }\n  };\n\n  if (isLoading)\n    return (\n      <div className=\"p-12 text-center text-gray-500\">\n        データを読み込み中...\n      </div>\n    );\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex justify-between items-center border-b pb-4\">\n        <div>\n          <h1 className=\"text-2xl font-bold text-gray-800\">請求内容の確認</h1>\n          <p className=\"text-sm text-gray-500 mt-1\">\n            取引先:{' '}\n            <span className=\"font-bold text-lg text-black\">{partnerName}</span>\n          </p>\n          <p className=\"text-sm text-gray-500\">\n            対象期間: {start} ～ {end}\n          </p>\n        </div>\n        <div className=\"flex gap-4\">\n          <Link\n            href=\"/invoices/create\"\n            className=\"px-4 py-2 bg-gray-100 text-gray-600 rounded hover:bg-gray-200\"\n          >\n            キャンセル\n          </Link>\n          {shipments.length > 0 && (\n            <button\n              onClick={handleConfirm}\n              disabled={isSubmitting}\n              className=\"px-6 py-2 bg-indigo-600 text-white font-bold rounded shadow hover:bg-indigo-500 disabled:opacity-50\"\n            >\n              確定して発行\n            </button>\n          )}\n        </div>\n      </div>\n      {shipments.length === 0 ? (\n        <div className=\"p-8 text-center bg-gray-50 rounded text-gray-500\">\n          対象データがありません\n        </div>\n      ) : (\n        <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-8\">\n          <div className=\"lg:col-span-2 space-y-4\">\n            <h2 className=\"font-bold text-gray-700\">\n              納品明細 ({shipments.length}件)\n            </h2>\n            <div className=\"border border-gray-200 rounded-lg overflow-hidden\">\n              {shipments.map((ship) => (\n                <div\n                  key={ship.id}\n                  className=\"border-b border-gray-200 last:border-b-0 bg-white\"\n                >\n                  <div className=\"bg-gray-50 px-4 py-2 flex justify-between items-center text-sm\">\n                    <div className=\"font-bold text-gray-700\">\n                      {new Date(ship.shipment_date).toLocaleDateString()}{' '}\n                      <span className=\"ml-2 font-mono text-gray-500\">\n                        No.{ship.delivery_note_number || ship.id.slice(0, 6)}\n                      </span>\n                    </div>\n                    <div className=\"font-bold text-gray-800\">\n                      小計: ¥{ship.total_amount.toLocaleString()}\n                    </div>\n                  </div>\n                  <div className=\"p-4\">\n                    <table className=\"w-full text-sm\">\n                      <thead>\n                        <tr className=\"text-xs text-gray-400 border-b\">\n                          <th className=\"text-left py-1\">品名 / 型番</th>\n                          <th className=\"text-right py-1 w-20\">数量</th>\n                          <th className=\"text-right py-1 w-24\">単価</th>\n                          <th className=\"text-right py-1 w-24\">金額</th>\n                        </tr>\n                      </thead>\n                      <tbody>\n                        {ship.shipment_items.map((item: any) => (\n                          <tr key={item.id}>\n                            <td className=\"py-2 pr-2\">\n                              <div className=\"text-gray-800\">\n                                {item.products?.name}\n                              </div>\n                            </td>\n                            <td className=\"py-2 text-right\">\n                              {item.quantity.toLocaleString()}\n                            </td>\n                            <td className=\"py-2 text-right\">\n                              @{item.unit_price.toLocaleString()}\n                            </td>\n                            <td className=\"py-2 text-right text-gray-700\">\n                              ¥{item.line_total.toLocaleString()}\n                            </td>\n                          </tr>\n                        ))}\n                      </tbody>\n                    </table>\n                  </div>\n                </div>\n              ))}\n            </div>\n          </div>\n          <div className=\"lg:col-span-1\">\n            <div className=\"bg-white border border-gray-200 rounded-lg p-6 shadow-sm sticky top-6\">\n              <h2 className=\"font-bold text-xl text-gray-800 mb-6 border-b pb-2\">\n                請求金額 合計\n              </h2>\n              <div className=\"space-y-3 mb-6\">\n                <div className=\"flex justify-between text-gray-600\">\n                  <span>税抜合計</span>\n                  <span className=\"font-bold\">\n                    ¥ {totalExclTax.toLocaleString()}\n                  </span>\n                </div>\n                <div className=\"flex justify-between text-gray-600\">\n                  <span>消費税 (10%)</span>\n                  <span className=\"font-bold\">¥ {tax.toLocaleString()}</span>\n                </div>\n              </div>\n              <div className=\"flex justify-between items-center border-t-2 border-gray-800 pt-4 mb-8\">\n                <span className=\"font-bold text-lg\">ご請求額</span>\n                <span className=\"font-bold text-2xl text-indigo-700\">\n                  ¥ {totalAmount.toLocaleString()}\n                </span>\n              </div>\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hibino\\otsudenki-portal\\src\\app\\(main)\\invoices\\create\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hibino\\otsudenki-portal\\src\\app\\(main)\\invoices\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":8,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":8,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[219,222],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[219,222],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":65,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":65,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2244,2247],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2244,2247],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useState, useEffect } from 'react';\nimport { getInvoices } from './actions';\nimport Link from 'next/link';\n\nexport default function InvoiceListPage() {\n  const [invoices, setInvoices] = useState<any[]>([]);\n  const [isLoading, setIsLoading] = useState(true);\n\n  useEffect(() => {\n    const load = async () => {\n      setIsLoading(true);\n      const data = await getInvoices();\n      setInvoices(data || []);\n      setIsLoading(false);\n    };\n    load();\n  }, []);\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex justify-between items-center\">\n        <h1 className=\"text-2xl font-bold text-gray-800\">請求書管理</h1>\n        <Link\n          href=\"/invoices/create\"\n          className=\"bg-indigo-600 text-white px-4 py-2 rounded shadow hover:bg-indigo-500 font-bold flex items-center gap-2\"\n        >\n          ＋ 新規作成\n        </Link>\n      </div>\n\n      <div className=\"bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden\">\n        {isLoading ? (\n          <div className=\"p-12 text-center text-gray-500\">読み込み中...</div>\n        ) : invoices.length === 0 ? (\n          <div className=\"p-12 text-center text-gray-500\">\n            請求書データがありません。\n            <br />\n            右上の「新規作成」から作成してください。\n          </div>\n        ) : (\n          <table className=\"min-w-full divide-y divide-gray-200\">\n            <thead className=\"bg-gray-50\">\n              <tr>\n                <th className=\"px-6 py-3 text-left text-xs font-bold text-gray-500\">\n                  発行日\n                </th>\n                <th className=\"px-6 py-3 text-left text-xs font-bold text-gray-500\">\n                  取引先\n                </th>\n                <th className=\"px-6 py-3 text-left text-xs font-bold text-gray-500\">\n                  対象期間\n                </th>\n                <th className=\"px-6 py-3 text-right text-xs font-bold text-gray-500\">\n                  請求金額(税込)\n                </th>\n                <th className=\"px-6 py-3 text-center text-xs font-bold text-gray-500\">\n                  操作\n                </th>\n              </tr>\n            </thead>\n            <tbody className=\"divide-y divide-gray-200\">\n              {invoices.map((inv) => {\n                const p = inv.partners as any;\n                const pName = Array.isArray(p) ? p[0]?.name : p?.name;\n                return (\n                  <tr key={inv.id} className=\"hover:bg-gray-50\">\n                    <td className=\"px-6 py-4 text-sm text-gray-600\">\n                      {new Date(inv.issue_date).toLocaleDateString()}\n                    </td>\n                    <td className=\"px-6 py-4 text-sm font-bold text-gray-800\">\n                      {pName || '(不明)'}\n                    </td>\n                    <td className=\"px-6 py-4 text-xs text-gray-500\">\n                      {new Date(inv.period_start).toLocaleDateString()} ～{' '}\n                      {new Date(inv.period_end).toLocaleDateString()}\n                    </td>\n                    <td className=\"px-6 py-4 text-sm font-bold text-right\">\n                      ¥ {inv.total_amount.toLocaleString()}\n                    </td>\n                    <td className=\"px-6 py-4 text-center\">\n                      <span className=\"text-xs text-gray-400\">PDF準備中</span>\n                    </td>\n                  </tr>\n                );\n              })}\n            </tbody>\n          </table>\n        )}\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hibino\\otsudenki-portal\\src\\app\\(main)\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hibino\\otsudenki-portal\\src\\app\\(main)\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hibino\\otsudenki-portal\\src\\app\\(main)\\partners\\actions.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":37,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":37,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1051,1054],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1051,1054],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":69,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":69,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1911,1914],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1911,1914],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":82,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":82,"endColumn":13},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":82,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":82,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2285,2288],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2285,2288],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use server';\n\nimport { createClient } from '@/utils/supabase/server';\nimport { revalidatePath } from 'next/cache';\n\n// 取引先一覧取得\nexport async function getPartners() {\n  const supabase = await createClient();\n  const { data } = await supabase.from('partners').select('*').order('code');\n  return data || [];\n}\n\n// 取引先登録\nexport async function createPartner(formData: FormData) {\n  const supabase = await createClient();\n\n  const name = formData.get('name') as string;\n  const code = formData.get('code') as string;\n  const address = formData.get('address') as string;\n  const phone = formData.get('phone') as string;\n  const memo = formData.get('memo') as string;\n  // 締め日は数値変換。空なら99(末)\n  const closingDate = Number(formData.get('closing_date') || 99);\n\n  try {\n    const { error } = await supabase.from('partners').insert({\n      name,\n      code,\n      address,\n      phone,\n      memo,\n      closing_date: closingDate,\n    });\n    if (error) throw error;\n    revalidatePath('/partners');\n    return { success: true, message: '登録しました' };\n  } catch (e: any) {\n    return { success: false, message: e.message };\n  }\n}\n\n// 取引先更新 (ここがエラーの原因でした)\nexport async function updatePartner(id: string, formData: FormData) {\n  const supabase = await createClient();\n\n  const name = formData.get('name') as string;\n  const code = formData.get('code') as string;\n  const address = formData.get('address') as string;\n  const phone = formData.get('phone') as string;\n  const memo = formData.get('memo') as string;\n  const closingDate = Number(formData.get('closing_date') || 99);\n\n  try {\n    const { error } = await supabase\n      .from('partners')\n      .update({\n        name,\n        code,\n        address,\n        phone,\n        memo,\n        closing_date: closingDate,\n      })\n      .eq('id', id);\n\n    if (error) throw error;\n    revalidatePath('/partners');\n    return { success: true, message: '更新しました' };\n  } catch (e: any) {\n    return { success: false, message: e.message };\n  }\n}\n\n// 取引先削除\nexport async function deletePartner(id: string) {\n  const supabase = await createClient();\n  try {\n    const { error } = await supabase.from('partners').delete().eq('id', id);\n    if (error) throw error;\n    revalidatePath('/partners');\n    return { success: true, message: '削除しました' };\n  } catch (e: any) {\n    return {\n      success: false,\n      message: '削除エラー: 関連データがある可能性があります',\n    };\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hibino\\otsudenki-portal\\src\\app\\(main)\\partners\\page.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\hibino\\otsudenki-portal\\src\\app\\(main)\\partners\\page.tsx:31:5\n  29 |\n  30 |   useEffect(() => {\n> 31 |     loadPartners();\n     |     ^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  32 |   }, []);\n  33 |\n  34 |   // 新規登録ボタン","line":31,"column":5,"nodeType":null,"endLine":31,"endColumn":17}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useState, useEffect } from 'react';\nimport {\n  getPartners,\n  createPartner,\n  updatePartner,\n  deletePartner,\n} from './actions';\nimport type { Partner } from '@/types/models';\n\nexport default function PartnersPage() {\n  const [partners, setPartners] = useState<Partner[]>([]);\n  const [isLoading, setIsLoading] = useState(true);\n\n  // 編集モーダル用\n  const [isEditing, setIsEditing] = useState(false);\n  const [formData, setFormData] = useState<Partial<Partner>>({\n    closing_date: 99,\n  });\n\n  // データロード\n  const loadPartners = async () => {\n    setIsLoading(true);\n    const data = await getPartners();\n    setPartners(data);\n    setIsLoading(false);\n  };\n\n  useEffect(() => {\n    loadPartners();\n  }, []);\n\n  // 新規登録ボタン\n  const handleCreate = () => {\n    setFormData({ closing_date: 99 }); // 初期値リセット\n    setIsEditing(true);\n  };\n\n  // 編集ボタン\n  const handleEdit = (p: Partner) => {\n    setFormData({ ...p });\n    setIsEditing(true);\n  };\n\n  // 削除ボタン\n  const handleDelete = async (id: string) => {\n    if (\n      !confirm(\n        'この取引先を削除しますか？\\n※関連する製品や履歴がある場合、エラーになる可能性があります。'\n      )\n    )\n      return;\n\n    const res = await deletePartner(id);\n    if (res.success) {\n      alert(res.message);\n      loadPartners();\n    } else {\n      alert(res.message);\n    }\n  };\n\n  // 保存処理\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    if (!formData.name) return alert('取引先名は必須です');\n\n    const fd = new FormData();\n    fd.set('name', formData.name);\n    fd.set('code', formData.code ?? '');\n    fd.set('address', formData.address ?? '');\n    fd.set('phone', formData.phone ?? '');\n    fd.set('memo', formData.memo ?? '');\n    fd.set('closing_date', String(formData.closing_date ?? 99));\n\n    const res = formData.id\n      ? await updatePartner(formData.id, fd)\n      : await createPartner(fd);\n    if (res.success) {\n      alert(res.message);\n      setIsEditing(false);\n      loadPartners();\n    } else {\n      alert(res.message);\n    }\n  };\n\n  // 締め日表示ヘルパー\n  const getClosingLabel = (day: number | null) => {\n    const value = day ?? 99;\n    if (value === 99)\n      return (\n        <span className=\"bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs font-bold\">\n          末締め\n        </span>\n      );\n    return (\n      <span className=\"bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs font-bold\">\n        {value}日締め\n      </span>\n    );\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex justify-between items-center\">\n        <h1 className=\"text-2xl font-bold text-gray-800\">取引先マスタ</h1>\n        <button\n          onClick={handleCreate}\n          className=\"bg-indigo-600 text-white px-4 py-2 rounded shadow hover:bg-indigo-700 transition-colors\"\n        >\n          ＋ 新規登録\n        </button>\n      </div>\n\n      <div className=\"bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden\">\n        {isLoading ? (\n          <div className=\"p-12 text-center text-gray-500\">読み込み中...</div>\n        ) : partners.length === 0 ? (\n          <div className=\"p-12 text-center text-gray-500\">\n            データがありません\n          </div>\n        ) : (\n          <table className=\"min-w-full divide-y divide-gray-200\">\n            <thead className=\"bg-gray-50\">\n              <tr>\n                <th className=\"px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider w-24\">\n                  コード\n                </th>\n                <th className=\"px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider\">\n                  取引先名\n                </th>\n                <th className=\"px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider w-32\">\n                  請求締め日\n                </th>\n                <th className=\"px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider\">\n                  連絡先 / メモ\n                </th>\n                <th className=\"px-6 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider w-32\">\n                  操作\n                </th>\n              </tr>\n            </thead>\n            <tbody className=\"bg-white divide-y divide-gray-200\">\n              {partners.map((p) => (\n                <tr key={p.id} className=\"hover:bg-gray-50\">\n                  <td className=\"px-6 py-4 text-sm font-mono text-gray-600\">\n                    {p.code || '-'}\n                  </td>\n                  <td className=\"px-6 py-4 text-sm font-bold text-gray-800\">\n                    {p.name}\n                  </td>\n                  <td className=\"px-6 py-4 text-sm\">\n                    {getClosingLabel(p.closing_date)}\n                  </td>\n                  <td className=\"px-6 py-4 text-sm text-gray-500\">\n                    <div>{p.address}</div>\n                    <div className=\"text-xs\">{p.phone}</div>\n                    {p.memo && (\n                      <div className=\"text-xs text-gray-400 mt-1\">\n                        ※{p.memo}\n                      </div>\n                    )}\n                  </td>\n                  <td className=\"px-6 py-4 text-center text-sm\">\n                    <button\n                      onClick={() => handleEdit(p)}\n                      className=\"text-indigo-600 hover:text-indigo-900 mr-4\"\n                    >\n                      編集\n                    </button>\n                    <button\n                      onClick={() => handleDelete(p.id)}\n                      className=\"text-red-600 hover:text-red-900\"\n                    >\n                      削除\n                    </button>\n                  </td>\n                </tr>\n              ))}\n            </tbody>\n          </table>\n        )}\n      </div>\n\n      {/* 編集モーダル */}\n      {isEditing && (\n        <div className=\"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4\">\n          <div className=\"bg-white rounded-lg shadow-xl w-full max-w-md\">\n            <div className=\"p-6 border-b border-gray-100\">\n              <h3 className=\"text-lg font-bold text-gray-900\">\n                {formData.id ? '取引先を編集' : '新規取引先登録'}\n              </h3>\n            </div>\n\n            <form onSubmit={handleSubmit} className=\"p-6 space-y-4\">\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <label className=\"block text-sm font-bold text-gray-700 mb-1\">\n                    取引先コード\n                  </label>\n                  <input\n                    type=\"text\"\n                    className=\"w-full border border-gray-300 rounded px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500\"\n                    placeholder=\"C001\"\n                    value={formData.code || ''}\n                    onChange={(e) =>\n                      setFormData({ ...formData, code: e.target.value })\n                    }\n                  />\n                </div>\n                <div>\n                  <label className=\"block text-sm font-bold text-gray-700 mb-1\">\n                    締め日設定\n                  </label>\n                  <select\n                    className=\"w-full border border-gray-300 rounded px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500\"\n                    value={formData.closing_date ?? 99}\n                    onChange={(e) =>\n                      setFormData({\n                        ...formData,\n                        closing_date: Number(e.target.value),\n                      })\n                    }\n                  >\n                    <option value={99}>末締め (デフォルト)</option>\n                    <option value={20}>20日締め</option>\n                    <option value={15}>15日締め</option>\n                    <option value={10}>10日締め</option>\n                    <option value={25}>25日締め</option>\n                    <option value={5}>5日締め</option>\n                  </select>\n                </div>\n              </div>\n\n              <div>\n                <label className=\"block text-sm font-bold text-gray-700 mb-1\">\n                  取引先名 <span className=\"text-red-500\">*</span>\n                </label>\n                <input\n                  type=\"text\"\n                  required\n                  className=\"w-full border border-gray-300 rounded px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500\"\n                  placeholder=\"株式会社〇〇\"\n                  value={formData.name || ''}\n                  onChange={(e) =>\n                    setFormData({ ...formData, name: e.target.value })\n                  }\n                />\n              </div>\n\n              <div>\n                <label className=\"block text-sm font-bold text-gray-700 mb-1\">\n                  住所\n                </label>\n                <input\n                  type=\"text\"\n                  className=\"w-full border border-gray-300 rounded px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500\"\n                  value={formData.address || ''}\n                  onChange={(e) =>\n                    setFormData({ ...formData, address: e.target.value })\n                  }\n                />\n              </div>\n\n              <div>\n                <label className=\"block text-sm font-bold text-gray-700 mb-1\">\n                  電話番号\n                </label>\n                <input\n                  type=\"text\"\n                  className=\"w-full border border-gray-300 rounded px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500\"\n                  value={formData.phone || ''}\n                  onChange={(e) =>\n                    setFormData({ ...formData, phone: e.target.value })\n                  }\n                />\n              </div>\n\n              <div>\n                <label className=\"block text-sm font-bold text-gray-700 mb-1\">\n                  メモ\n                </label>\n                <textarea\n                  className=\"w-full border border-gray-300 rounded px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500\"\n                  rows={2}\n                  value={formData.memo || ''}\n                  onChange={(e) =>\n                    setFormData({ ...formData, memo: e.target.value })\n                  }\n                />\n              </div>\n\n              <div className=\"flex justify-end gap-3 pt-4 border-t border-gray-100\">\n                <button\n                  type=\"button\"\n                  onClick={() => setIsEditing(false)}\n                  className=\"px-4 py-2 text-gray-600 bg-gray-100 rounded hover:bg-gray-200\"\n                >\n                  キャンセル\n                </button>\n                <button\n                  type=\"submit\"\n                  className=\"px-6 py-2 text-white bg-indigo-600 rounded font-bold hover:bg-indigo-700 shadow\"\n                >\n                  保存する\n                </button>\n              </div>\n            </form>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hibino\\otsudenki-portal\\src\\app\\(main)\\partners\\partner-list.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":6,"column":63,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":6,"endColumn":66,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[189,192],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[189,192],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useState } from 'react';\nimport { updatePartner, deletePartner } from './actions'; // 修正: 正しい名前でインポート\n\nexport default function PartnerList({ partners }: { partners: any[] }) {\n  const [editingId, setEditingId] = useState<string | null>(null);\n\n  const handleDelete = async (id: string) => {\n    if (!confirm('本当に削除しますか？')) return;\n    const res = await deletePartner(id);\n    alert(res.message);\n  };\n\n  const handleUpdate = async (e: React.FormEvent<HTMLFormElement>) => {\n    e.preventDefault();\n    if (!editingId) return;\n    const formData = new FormData(e.currentTarget);\n    const res = await updatePartner(editingId, formData);\n    alert(res.message);\n    if (res.success) setEditingId(null);\n  };\n\n  return (\n    <div className=\"bg-white shadow rounded-lg overflow-hidden border border-gray-200\">\n      <table className=\"min-w-full divide-y divide-gray-200\">\n        <thead className=\"bg-gray-50\">\n          <tr>\n            <th className=\"px-6 py-3 text-left text-xs font-bold text-gray-500\">\n              コード\n            </th>\n            <th className=\"px-6 py-3 text-left text-xs font-bold text-gray-500\">\n              取引先名\n            </th>\n            <th className=\"px-6 py-3 text-left text-xs font-bold text-gray-500\">\n              締め日\n            </th>\n            <th className=\"px-6 py-3 text-right text-xs font-bold text-gray-500\">\n              操作\n            </th>\n          </tr>\n        </thead>\n        <tbody className=\"divide-y divide-gray-200\">\n          {partners.map((p) => (\n            <tr key={p.id} className=\"hover:bg-gray-50\">\n              {editingId === p.id ? (\n                <td colSpan={4} className=\"p-4 bg-blue-50\">\n                  <form\n                    onSubmit={handleUpdate}\n                    className=\"flex gap-2 items-center\"\n                  >\n                    <input\n                      name=\"code\"\n                      defaultValue={p.code}\n                      className=\"border p-1 w-20 rounded\"\n                      placeholder=\"コード\"\n                      required\n                    />\n                    <input\n                      name=\"name\"\n                      defaultValue={p.name}\n                      className=\"border p-1 flex-1 rounded\"\n                      placeholder=\"取引先名\"\n                      required\n                    />\n                    <select\n                      name=\"closing_date\"\n                      defaultValue={p.closing_date}\n                      className=\"border p-1 w-24 rounded\"\n                    >\n                      <option value=\"99\">末締め</option>\n                      <option value=\"20\">20日</option>\n                      <option value=\"15\">15日</option>\n                      <option value=\"10\">10日</option>\n                    </select>\n                    <button\n                      type=\"submit\"\n                      className=\"bg-blue-600 text-white px-3 py-1 rounded text-sm\"\n                    >\n                      保存\n                    </button>\n                    <button\n                      type=\"button\"\n                      onClick={() => setEditingId(null)}\n                      className=\"bg-gray-400 text-white px-3 py-1 rounded text-sm\"\n                    >\n                      中止\n                    </button>\n                  </form>\n                </td>\n              ) : (\n                <>\n                  <td className=\"px-6 py-4 text-sm font-mono text-gray-600\">\n                    {p.code}\n                  </td>\n                  <td className=\"px-6 py-4 text-sm font-bold text-gray-800\">\n                    {p.name}\n                  </td>\n                  <td className=\"px-6 py-4 text-sm text-gray-500\">\n                    {p.closing_date === 99\n                      ? '末締め'\n                      : `${p.closing_date}日締め`}\n                  </td>\n                  <td className=\"px-6 py-4 text-right text-sm space-x-2\">\n                    <button\n                      onClick={() => setEditingId(p.id)}\n                      className=\"text-indigo-600 hover:text-indigo-900 font-bold\"\n                    >\n                      編集\n                    </button>\n                    <button\n                      onClick={() => handleDelete(p.id)}\n                      className=\"text-red-600 hover:text-red-900\"\n                    >\n                      削除\n                    </button>\n                  </td>\n                </>\n              )}\n            </tr>\n          ))}\n        </tbody>\n      </table>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hibino\\otsudenki-portal\\src\\app\\(main)\\prices\\actions.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":40,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":40,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1001,1004],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1001,1004],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":52,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":52,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1360,1363],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1360,1363],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use server';\n\nimport { createClient } from '@/utils/supabase/server';\nimport { revalidatePath } from 'next/cache';\n\nexport async function getPrices() {\n  const supabase = await createClient();\n  const { data } = await supabase\n    .from('prices')\n    .select(\n      `\n      *,\n      products ( name, product_code, color )\n    `\n    )\n    .order('valid_from', { ascending: false });\n\n  return (\n    data?.map((d) => ({\n      ...d,\n      products: Array.isArray(d.products) ? d.products[0] : d.products,\n    })) || []\n  );\n}\n\nexport async function createPrice(formData: FormData) {\n  const supabase = await createClient();\n  const rawData = {\n    product_id: formData.get('product_id'),\n    unit_price: formData.get('unit_price'),\n    valid_from: formData.get('valid_from'),\n    status: 'active',\n  };\n\n  try {\n    const { error } = await supabase.from('prices').insert(rawData);\n    if (error) throw error;\n    revalidatePath('/prices');\n    return { success: true, message: '登録しました' };\n  } catch (e: any) {\n    return { success: false, message: e.message };\n  }\n}\n\nexport async function deletePrice(id: string) {\n  const supabase = await createClient();\n  try {\n    const { error } = await supabase.from('prices').delete().eq('id', id);\n    if (error) throw error;\n    revalidatePath('/prices');\n    return { success: true, message: '削除しました' };\n  } catch (e: any) {\n    return { success: false, message: e.message };\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hibino\\otsudenki-portal\\src\\app\\(main)\\prices\\bulk\\actions.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":105,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":105,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2832,2835],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2832,2835],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use server';\n\nimport { createClient } from '@/utils/supabase/server';\nimport { revalidatePath } from 'next/cache';\n\nexport type BulkRegistrationResult = {\n  success: boolean;\n  message: string;\n  count?: number;\n  updatedCount?: number; // 更新件数も返すようにする\n};\n\n// 登録データの型定義\ntype PriceInput = {\n  product_id: number;\n  unit_price: number;\n  valid_from: string;\n  reason?: string;\n};\n\nexport async function bulkUpsertPrices(\n  data: PriceInput[]\n): Promise<BulkRegistrationResult> {\n  const supabase = await createClient();\n\n  // 1. ユーザー確認\n  const {\n    data: { user },\n  } = await supabase.auth.getUser();\n  if (!user) return { success: false, message: 'ログインしていません' };\n\n  // 2. 権限確認\n  const { data: profile } = await supabase\n    .from('profiles')\n    .select('role')\n    .eq('id', user.id)\n    .single();\n\n  const defaultStatus =\n    profile?.role === 'admin' || profile?.role === 'manager'\n      ? 'active'\n      : 'pending';\n\n  let insertCount = 0;\n  let updateCount = 0;\n\n  try {\n    // 3. ループ処理で1件ずつ「確認 -> 登録or更新」を行う\n    // (件数が数千件レベルなら bulk upsert SQL の方が速いが、数百件ならこの方が安全確実)\n    for (const item of data) {\n      // 同じ製品・同じ開始日のデータがあるか探す\n      const { data: existing } = await supabase\n        .from('prices')\n        .select('id')\n        .eq('product_id', item.product_id)\n        .eq('valid_from', item.valid_from)\n        .single();\n\n      if (existing) {\n        // --- ある場合：更新 (UPDATE) ---\n        const { error } = await supabase\n          .from('prices')\n          .update({\n            unit_price: item.unit_price,\n            reason: item.reason || null,\n            // 修正時はステータスをどうするか？\n            // Adminならそのままactive維持でもいいが、金額が変わるので再承認フローに載せるか？\n            // ここでは「AdminならActive、それ以外はPending」にリセットする仕様にします\n            status: defaultStatus,\n            created_by: user.id, // 最終更新者として記録\n            approved_by: defaultStatus === 'active' ? user.id : null,\n            approved_at:\n              defaultStatus === 'active' ? new Date().toISOString() : null,\n          })\n          .eq('id', existing.id);\n\n        if (error) throw error;\n        updateCount++;\n      } else {\n        // --- ない場合：新規登録 (INSERT) ---\n        const { error } = await supabase.from('prices').insert({\n          product_id: item.product_id,\n          unit_price: item.unit_price,\n          valid_from: item.valid_from,\n          reason: item.reason || null,\n          status: defaultStatus,\n          created_by: user.id,\n          approved_by: defaultStatus === 'active' ? user.id : null,\n          approved_at:\n            defaultStatus === 'active' ? new Date().toISOString() : null,\n        });\n\n        if (error) throw error;\n        insertCount++;\n      }\n    }\n\n    revalidatePath('/prices');\n    return {\n      success: true,\n      message: '処理完了',\n      count: insertCount,\n      updatedCount: updateCount,\n    };\n  } catch (error: any) {\n    console.error('Bulk Upsert Error:', error);\n    return {\n      success: false,\n      message: 'エラーが発生しました: ' + error.message,\n    };\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hibino\\otsudenki-portal\\src\\app\\(main)\\prices\\bulk\\bulk-register.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hibino\\otsudenki-portal\\src\\app\\(main)\\prices\\bulk\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":25,"column":55,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":25,"endColumn":58,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[666,669],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[666,669],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createClient } from '@/utils/supabase/server';\nimport BulkRegister from './bulk-register';\nimport Link from 'next/link';\n\nexport default async function BulkRegisterPage() {\n  const supabase = await createClient();\n\n  // テンプレート生成用に、廃盤でない全製品を取得\n  // カラム名を修正: customer_product_code -> product_code, color_text -> color\n  const { data: products } = await supabase\n    .from('products')\n    .select(\n      `\n      id,\n      product_code, \n      name,\n      color,\n      partners ( name )\n    `\n    )\n    .eq('is_discontinued', false)\n    .order('product_code');\n\n  // Supabaseのリレーションは配列で返るため、1件だけ取り出して型を合わせる\n  const normalizedProducts = (products || []).map((p: any) => ({\n    ...p,\n    partners: Array.isArray(p.partners) ? (p.partners[0] ?? null) : p.partners,\n  }));\n\n  return (\n    <div className=\"max-w-5xl mx-auto\">\n      <div className=\"flex items-center justify-between mb-8\">\n        <div>\n          <h1 className=\"text-2xl font-bold text-gray-900\">単価一括登録</h1>\n          <p className=\"text-gray-600 mt-2\">\n            製品リスト入りテンプレートをダウンロードし、単価を入力してアップロードしてください。\n          </p>\n        </div>\n        <Link\n          href=\"/prices\"\n          className=\"text-sm font-semibold text-gray-900 hover:text-gray-700\"\n        >\n          一覧に戻る\n        </Link>\n      </div>\n\n      <BulkRegister products={normalizedProducts} />\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hibino\\otsudenki-portal\\src\\app\\(main)\\prices\\new\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hibino\\otsudenki-portal\\src\\app\\(main)\\prices\\new\\form-content.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hibino\\otsudenki-portal\\src\\app\\(main)\\prices\\new\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":22,"column":55,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":22,"endColumn":58,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[561,564],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[561,564],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createClient } from '@/utils/supabase/server';\nimport FormContent from './form-content';\n\nexport default async function NewPricePage() {\n  const supabase = await createClient();\n\n  // 修正: customer_product_code -> product_code, color_text -> color\n  const { data: products } = await supabase\n    .from('products')\n    .select(\n      `\n      id,\n      name,\n      product_code,\n      color,\n      partners ( name )\n    `\n    )\n    .eq('is_discontinued', false) // 廃盤品は除外\n    .order('product_code');\n\n  const normalizedProducts = (products || []).map((p: any) => ({\n    ...p,\n    partners: Array.isArray(p.partners) ? (p.partners[0] ?? null) : p.partners,\n  }));\n\n  return (\n    <div className=\"max-w-2xl mx-auto\">\n      <div className=\"mb-8\">\n        <h1 className=\"text-2xl font-bold text-gray-900\">単価新規登録</h1>\n        <p className=\"text-gray-600 mt-2\">\n          既存の製品に対して、新しい適用単価を登録します。\n        </p>\n      </div>\n\n      <div className=\"bg-white shadow rounded-lg p-6\">\n        <FormContent products={normalizedProducts} />\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hibino\\otsudenki-portal\\src\\app\\(main)\\prices\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":89,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":89,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2170,2173],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2170,2173],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createClient } from '@/utils/supabase/server';\nimport PriceMatrix from './price-list'; // ファイル名はそのままで中身を変えます\nimport { Partner } from '@/types/models';\n\ntype Props = {\n  searchParams: Promise<{ [key: string]: string | string[] | undefined }>;\n};\n\nexport default async function PricesPage(props: Props) {\n  const searchParams = await props.searchParams;\n  const supabase = await createClient();\n\n  const partnerName =\n    typeof searchParams.partner === 'string' ? searchParams.partner : '';\n  const keyword = typeof searchParams.q === 'string' ? searchParams.q : '';\n  // デフォルトでは廃盤を表示しない\n  const showDiscontinued = searchParams.show_discontinued === 'true';\n\n  // --- 1. 製品データを主軸に取得 ---\n  // 製品に関連する「全ての」単価情報を取得します\n  let query = supabase.from('products').select(`\n      *,\n      partners!inner ( name ),\n      prices (\n        id,\n        unit_price,\n        valid_from,\n        reason,\n        status\n      )\n    `);\n\n  // (A) 廃盤フィルタ\n  if (!showDiscontinued) {\n    query = query.eq('is_discontinued', false);\n  }\n\n  // (B) 取引先フィルタ\n  if (partnerName) {\n    query = query.eq('partners.name', partnerName);\n  }\n\n  // (C) キーワード検索\n  if (keyword) {\n    query = query.or(\n      `product_code.ilike.%${keyword}%,name.ilike.%${keyword}%,color.ilike.%${keyword}%,memo.ilike.%${keyword}%`\n    );\n  }\n\n  // ソートと件数制限\n  query = query\n    .order('partners(name)', { ascending: true }) // 取引先順\n    .order('product_code', { ascending: true }) // 型番順\n    .limit(2000);\n\n  // --- 2. 取引先マスタ取得 ---\n  const partnersQuery = supabase\n    .from('partners')\n    .select('id, name')\n    .order('name');\n\n  // --- 3. ユーザー権限確認 ---\n  const {\n    data: { user },\n  } = await supabase.auth.getUser();\n  const { data: profile } = await supabase\n    .from('profiles')\n    .select('role')\n    .eq('id', user?.id)\n    .single();\n\n  const userRole = profile?.role || 'staff';\n\n  const [productsResult, partnersResult] = await Promise.all([\n    query,\n    partnersQuery,\n  ]);\n\n  if (productsResult.error) {\n    return (\n      <div className=\"text-red-500\">\n        データ取得エラー: {productsResult.error.message}\n      </div>\n    );\n  }\n\n  return (\n    <PriceMatrix\n      products={productsResult.data as any[]}\n      masterPartners={partnersResult.data as Partner[]}\n      userRole={userRole}\n    />\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hibino\\otsudenki-portal\\src\\app\\(main)\\prices\\price-list.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hibino\\otsudenki-portal\\src\\app\\(main)\\products\\actions.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":38,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":38,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1005,1008],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1005,1008],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'id' is defined but never used.","line":43,"column":37,"nodeType":"Identifier","messageId":"unusedVar","endLine":43,"endColumn":39},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'formData' is defined but never used.","line":43,"column":49,"nodeType":"Identifier","messageId":"unusedVar","endLine":43,"endColumn":57},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'supabase' is assigned a value but never used.","line":44,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":44,"endColumn":17},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":57,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":57,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1645,1648],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1645,1648],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use server';\n\nimport { createClient } from '@/utils/supabase/server';\nimport { revalidatePath } from 'next/cache';\n\nexport async function getProducts() {\n  const supabase = await createClient();\n  const { data } = await supabase\n    .from('products')\n    .select('*, partners(name)')\n    .order('product_code');\n\n  // 安全な型変換\n  return (\n    data?.map((d) => ({\n      ...d,\n      partners: Array.isArray(d.partners) ? d.partners[0] : d.partners,\n    })) || []\n  );\n}\n\nexport async function createProduct(formData: FormData) {\n  const supabase = await createClient();\n\n  const rawData = {\n    partner_id: formData.get('partner_id'),\n    name: formData.get('name'),\n    product_code: formData.get('product_code'),\n    color: formData.get('color'),\n    unit_weight: formData.get('unit_weight') || 0,\n  };\n\n  try {\n    const { error } = await supabase.from('products').insert(rawData);\n    if (error) throw error;\n    revalidatePath('/products');\n    return { success: true, message: '登録しました' };\n  } catch (e: any) {\n    return { success: false, message: e.message };\n  }\n}\n\nexport async function updateProduct(id: string, formData: FormData) {\n  const supabase = await createClient(); // ここにupdate処理が必要です\n  // 簡易実装: 今回は一覧表示でのエラーを防ぐためここまでとしますが、\n  // 必要であればupdate処理も実装します。まずはビルドを通すために必須関数だけ整備します。\n  return { success: true, message: '更新機能は準備中です' };\n}\n\nexport async function deleteProduct(id: string) {\n  const supabase = await createClient();\n  try {\n    const { error } = await supabase.from('products').delete().eq('id', id);\n    if (error) throw error;\n    revalidatePath('/products');\n    return { success: true, message: '削除しました' };\n  } catch (e: any) {\n    return { success: false, message: e.message };\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hibino\\otsudenki-portal\\src\\app\\(main)\\products\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hibino\\otsudenki-portal\\src\\app\\(main)\\products\\product-list.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hibino\\otsudenki-portal\\src\\app\\(main)\\shipments\\[id]\\print\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'createClient' is defined but never used.","line":1,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":1,"endColumn":22,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"createClient"},"fix":{"range":[0,55],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":97,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":97,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3733,3736],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3733,3736],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createClient } from '@/utils/supabase/server';\nimport { getShipmentForPrint } from '@/app/(main)/inventory/actions';\nimport { notFound } from 'next/navigation';\nimport PrintButton from './print-button'; // ★作成した部品をインポート\n\nexport default async function PrintShipmentPage({\n  params,\n}: {\n  params: { id: string };\n}) {\n  // パラメータ取得の非同期対応\n  const { id } = await params;\n  const shipment = await getShipmentForPrint(id);\n\n  if (!shipment) return notFound();\n\n  const subTotal = shipment.total_amount;\n  const tax = Math.floor(subTotal * 0.1); // 消費税10%\n  const total = subTotal + tax;\n\n  return (\n    <div className=\"bg-white min-h-screen text-black p-8 md:p-12 print:p-0 print:text-sm\">\n      {/* ★修正: クライアントコンポーネント（ボタン）を配置 */}\n      <PrintButton />\n\n      {/* 納品書レイアウト (A4縦) */}\n      <div className=\"max-w-[210mm] mx-auto border border-gray-200 p-8 print:border-none print:p-0\">\n        {/* ヘッダー */}\n        <div className=\"flex justify-between items-end border-b-2 border-gray-800 pb-4 mb-8\">\n          <div>\n            <h1 className=\"text-3xl font-serif font-bold mb-2\">納 品 書</h1>\n            <p className=\"text-sm text-gray-600\">\n              No.{' '}\n              {shipment.delivery_note_number ||\n                shipment.id.slice(0, 8).toUpperCase()}\n            </p>\n            <p className=\"text-sm text-gray-600\">\n              発行日: {new Date().toLocaleDateString('ja-JP')}\n            </p>\n          </div>\n          <div className=\"text-right\">\n            <h2 className=\"text-xl font-bold mb-1\">\n              {shipment.partners?.name} 御中\n            </h2>\n            <p className=\"text-sm text-gray-500\">\n              下記の通り納品いたしました。\n            </p>\n          </div>\n        </div>\n\n        {/* 自社情報 & 合計金額 */}\n        <div className=\"flex justify-between mb-8\">\n          <div className=\"w-1/2\">\n            <div className=\"border-b border-gray-400 mb-2 pb-1\">\n              <span className=\"text-sm text-gray-500\">納品日</span>\n              <span className=\"ml-4 font-bold text-lg\">\n                {new Date(shipment.shipment_date).toLocaleDateString('ja-JP')}\n              </span>\n            </div>\n            <div className=\"mt-4\">\n              <div className=\"flex justify-between border-b border-gray-300 py-1\">\n                <span>税抜合計</span>\n                <span>¥ {subTotal.toLocaleString()}</span>\n              </div>\n              <div className=\"flex justify-between border-b border-gray-300 py-1\">\n                <span>消費税 (10%)</span>\n                <span>¥ {tax.toLocaleString()}</span>\n              </div>\n              <div className=\"flex justify-between border-b-2 border-black py-1 mt-1 font-bold text-xl\">\n                <span>ご請求金額</span>\n                <span>¥ {total.toLocaleString()}</span>\n              </div>\n            </div>\n          </div>\n\n          <div className=\"w-1/3 text-sm text-right leading-relaxed\">\n            <p className=\"font-bold text-lg mb-1\">大津電機工業株式会社</p>\n            <p>〒520-0000</p>\n            <p>滋賀県大津市〇〇町1-1-1</p>\n            <p>TEL: 077-000-0000</p>\n            <p>担当: {shipment.created_by?.email || '営業部'}</p>\n          </div>\n        </div>\n\n        {/* 明細テーブル */}\n        <table className=\"w-full text-sm border-collapse\">\n          <thead>\n            <tr className=\"bg-gray-100 border-t border-b border-gray-800\">\n              <th className=\"py-2 px-2 text-left w-12\">No.</th>\n              <th className=\"py-2 px-2 text-left\">品名 / 型番 / 色</th>\n              <th className=\"py-2 px-2 text-right w-24\">数量</th>\n              <th className=\"py-2 px-2 text-right w-24\">単価</th>\n              <th className=\"py-2 px-2 text-right w-28\">金額</th>\n            </tr>\n          </thead>\n          <tbody>\n            {shipment.items.map((item: any, index: number) => (\n              <tr key={item.id} className=\"border-b border-gray-300\">\n                <td className=\"py-3 px-2 text-center\">{index + 1}</td>\n                <td className=\"py-3 px-2\">\n                  <div className=\"font-bold text-gray-800\">\n                    {item.products?.name}\n                  </div>\n                  <div className=\"text-xs text-gray-500\">\n                    {item.products?.product_code} {item.products?.color}\n                  </div>\n                </td>\n                <td className=\"py-3 px-2 text-right\">\n                  {item.quantity.toLocaleString()}\n                </td>\n                <td className=\"py-3 px-2 text-right\">\n                  @{item.unit_price.toLocaleString()}\n                </td>\n                <td className=\"py-3 px-2 text-right font-bold\">\n                  ¥ {item.line_total.toLocaleString()}\n                </td>\n              </tr>\n            ))}\n            {/* 空行埋め */}\n            {Array.from({\n              length: Math.max(0, 10 - shipment.items.length),\n            }).map((_, i) => (\n              <tr key={`empty-${i}`} className=\"border-b border-gray-200 h-12\">\n                <td></td>\n                <td></td>\n                <td></td>\n                <td></td>\n                <td></td>\n              </tr>\n            ))}\n          </tbody>\n        </table>\n\n        {/* 備考欄 */}\n        <div className=\"mt-8 border border-gray-400 rounded p-4 h-32\">\n          <p className=\"text-xs text-gray-500 mb-1\">備考</p>\n          <p className=\"text-sm\"></p>\n        </div>\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hibino\\otsudenki-portal\\src\\app\\(main)\\shipments\\[id]\\print\\print-button.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hibino\\otsudenki-portal\\src\\app\\(main)\\shipments\\page.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\hibino\\otsudenki-portal\\src\\app\\(main)\\shipments\\page.tsx:31:5\n  29 |\n  30 |   useEffect(() => {\n> 31 |     loadData();\n     |     ^^^^^^^^ Avoid calling setState() directly within an effect\n  32 |   }, []);\n  33 |\n  34 |   const handleDelete = async (id: string) => {","line":31,"column":5,"nodeType":null,"endLine":31,"endColumn":13}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useState, useEffect } from 'react';\nimport Link from 'next/link';\nimport {\n  getShipmentList,\n  deleteShipment,\n} from '@/app/(main)/inventory/actions';\n\ntype Shipment = {\n  id: string;\n  shipment_date: string;\n  delivery_note_number: string | null;\n  total_amount: number;\n  partners: { name: string } | null;\n  created_at: string;\n};\n\nexport default function ShipmentListPage() {\n  const [shipments, setShipments] = useState<Shipment[]>([]);\n  const [isLoading, setIsLoading] = useState(true);\n\n  const loadData = async () => {\n    setIsLoading(true);\n    const data = await getShipmentList();\n    setShipments(data || []);\n    setIsLoading(false);\n  };\n\n  useEffect(() => {\n    loadData();\n  }, []);\n\n  const handleDelete = async (id: string) => {\n    if (\n      !confirm(\n        'この納品書を削除してもよろしいですか？\\n\\n・出荷データが完全に取り消されます\\n・製品在庫が元の数に戻ります'\n      )\n    )\n      return;\n\n    const res = await deleteShipment(id);\n    if (res.success) {\n      alert(res.message);\n      loadData(); // リロード\n    } else {\n      alert(res.message);\n    }\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex justify-between items-center\">\n        <h1 className=\"text-2xl font-bold text-gray-800\">納品書 管理</h1>\n        <div className=\"flex gap-4\">\n          <Link\n            href=\"/inventory\"\n            className=\"px-4 py-2 bg-gray-100 text-gray-600 rounded hover:bg-gray-200 transition-colors\"\n          >\n            ← 在庫・出荷登録へ戻る\n          </Link>\n          <button\n            onClick={loadData}\n            className=\"px-4 py-2 bg-blue-50 text-blue-600 rounded hover:bg-blue-100 transition-colors\"\n          >\n            更新\n          </button>\n        </div>\n      </div>\n\n      <div className=\"bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden\">\n        {isLoading ? (\n          <div className=\"p-12 text-center text-gray-500\">読み込み中...</div>\n        ) : shipments.length === 0 ? (\n          <div className=\"p-12 text-center text-gray-500\">\n            納品書データがありません\n          </div>\n        ) : (\n          <table className=\"min-w-full divide-y divide-gray-200\">\n            <thead className=\"bg-gray-50\">\n              <tr>\n                <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\n                  納品日\n                </th>\n                <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\n                  No.\n                </th>\n                <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\n                  取引先\n                </th>\n                <th className=\"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider\">\n                  合計金額\n                </th>\n                <th className=\"px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider\">\n                  操作\n                </th>\n              </tr>\n            </thead>\n            <tbody className=\"bg-white divide-y divide-gray-200\">\n              {shipments.map((shipment) => (\n                <tr\n                  key={shipment.id}\n                  className=\"hover:bg-gray-50 transition-colors\"\n                >\n                  <td className=\"px-6 py-4 whitespace-nowrap text-sm text-gray-900\">\n                    {new Date(shipment.shipment_date).toLocaleDateString(\n                      'ja-JP'\n                    )}\n                  </td>\n                  <td className=\"px-6 py-4 whitespace-nowrap text-sm font-mono text-gray-500\">\n                    {shipment.delivery_note_number ||\n                      shipment.id.slice(0, 8).toUpperCase()}\n                  </td>\n                  <td className=\"px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-800\">\n                    {shipment.partners?.name}\n                  </td>\n                  <td className=\"px-6 py-4 whitespace-nowrap text-sm text-right font-bold text-gray-800\">\n                    ¥ {shipment.total_amount.toLocaleString()}\n                  </td>\n                  <td className=\"px-6 py-4 whitespace-nowrap text-center text-sm font-medium flex justify-center gap-4\">\n                    {/* 印刷ボタン */}\n                    <a\n                      href={`/shipments/${shipment.id}/print`}\n                      target=\"_blank\"\n                      rel=\"noopener noreferrer\"\n                      className=\"text-blue-600 hover:text-blue-900 flex items-center gap-1\"\n                    >\n                      <svg\n                        xmlns=\"http://www.w3.org/2000/svg\"\n                        viewBox=\"0 0 20 20\"\n                        fill=\"currentColor\"\n                        className=\"w-4 h-4\"\n                      >\n                        <path\n                          fillRule=\"evenodd\"\n                          d=\"M5 2.75C5 1.784 5.784 1 6.75 1h6.5c.966 0 1.75.784 1.75 1.75v3.5a.75.75 0 01-1.5 0v-2a.25.25 0 00-.25-.25h-6.5a.25.25 0 00-.25.25v2a.75.75 0 01-1.5 0v-3.5zm2.5 8.5a.75.75 0 01.75-.75h6.5a.75.75 0 010 1.5h-6.5a.75.75 0 01-.75-.75zm0 3a.75.75 0 01.75-.75h6.5a.75.75 0 010 1.5h-6.5a.75.75 0 01-.75-.75zM2 10a4 4 0 014-4h1.5a.75.75 0 010 1.5H6a2.5 2.5 0 00-2.5 2.5v5.5A2.5 2.5 0 006 18h1.5a.75.75 0 010 1.5H6a4 4 0 01-4-4v-5.5zm12 0a4 4 0 014-4h-1.5a.75.75 0 000 1.5H18a2.5 2.5 0 012.5 2.5v5.5a2.5 2.5 0 01-2.5 2.5h-1.5a.75.75 0 000 1.5H18a4 4 0 004-4v-5.5z\"\n                          clipRule=\"evenodd\"\n                        />\n                      </svg>\n                      印刷\n                    </a>\n\n                    {/* 削除ボタン */}\n                    <button\n                      onClick={() => handleDelete(shipment.id)}\n                      className=\"text-red-600 hover:text-red-900 flex items-center gap-1\"\n                    >\n                      <svg\n                        xmlns=\"http://www.w3.org/2000/svg\"\n                        viewBox=\"0 0 20 20\"\n                        fill=\"currentColor\"\n                        className=\"w-4 h-4\"\n                      >\n                        <path\n                          fillRule=\"evenodd\"\n                          d=\"M8.75 1A2.75 2.75 0 006 3.75v.443c-.795.077-1.584.176-2.365.298a.75.75 0 10.23 1.482l.149-.022.841 10.518A2.75 2.75 0 007.596 19h4.807a2.75 2.75 0 002.742-2.53l.841-10.52.149.023a.75.75 0 00.23-1.482A41.03 41.03 0 0014 4.193V3.75A2.75 2.75 0 0011.25 1h-2.5zM10 4c.84 0 1.673.025 2.5.075V3.75c0-.69-.56-1.25-1.25-1.25h-2.5c-.69 0-1.25.56-1.25 1.25v.325C8.327 4.025 9.16 4 10 4zM8.58 7.72a.75.75 0 00-1.5.06l.3 7.5a.75.75 0 101.5-.06l-.3-7.5zm4.34.06a.75.75 0 10-1.5-.06l-.3 7.5a.75.75 0 101.5.06l.3-7.5z\"\n                          clipRule=\"evenodd\"\n                        />\n                      </svg>\n                      取消\n                    </button>\n                  </td>\n                </tr>\n              ))}\n            </tbody>\n          </table>\n        )}\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hibino\\otsudenki-portal\\src\\app\\(main)\\users\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hibino\\otsudenki-portal\\src\\app\\(main)\\users\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hibino\\otsudenki-portal\\src\\app\\(main)\\users\\user-list.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hibino\\otsudenki-portal\\src\\app\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hibino\\otsudenki-portal\\src\\app\\login\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hibino\\otsudenki-portal\\src\\app\\login\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hibino\\otsudenki-portal\\src\\components\\Sidebar.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\hibino\\otsudenki-portal\\src\\components\\Sidebar.tsx:25:7\n  23 |     const savedPin = localStorage.getItem('sidebar-pinned');\n  24 |     if (savedPin !== null) {\n> 25 |       setIsPinned(savedPin === 'true');\n     |       ^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  26 |     }\n  27 |   }, []);\n  28 |","line":25,"column":7,"nodeType":null,"endLine":25,"endColumn":18}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useState, useEffect } from 'react';\nimport Link from 'next/link';\nimport { usePathname, useRouter } from 'next/navigation';\nimport { createClient } from '@/utils/supabase/client';\n\ntype User = {\n  email?: string;\n};\n\nexport default function Sidebar({ user }: { user: User | null }) {\n  const pathname = usePathname();\n  const router = useRouter();\n  const supabase = createClient();\n\n  // --- ステート管理 ---\n  const [isPinned, setIsPinned] = useState(true);\n  const [isHovered, setIsHovered] = useState(false);\n\n  // 初期化時にlocalStorageからピン留め設定を読み込む\n  useEffect(() => {\n    const savedPin = localStorage.getItem('sidebar-pinned');\n    if (savedPin !== null) {\n      setIsPinned(savedPin === 'true');\n    }\n  }, []);\n\n  // ピン留め切り替え\n  const togglePin = () => {\n    const newState = !isPinned;\n    setIsPinned(newState);\n    localStorage.setItem('sidebar-pinned', String(newState));\n  };\n\n  // ログアウト処理\n  const handleSignOut = async () => {\n    await supabase.auth.signOut();\n    router.refresh();\n  };\n\n  // 表示状態の判定\n  const isExpanded = isPinned || isHovered;\n\n  // --- メニュー定義 (グループ化) ---\n  const menuGroups = [\n    {\n      title: null, // タイトルなし (ホームなど)\n      items: [\n        {\n          name: 'ホーム',\n          href: '/',\n          icon: (\n            <path\n              strokeLinecap=\"round\"\n              strokeLinejoin=\"round\"\n              d=\"M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25\"\n            />\n          ),\n        },\n      ],\n    },\n    {\n      title: '販売・製造', // 業務系グループ\n      items: [\n        {\n          name: '業務管理',\n          href: '/inventory',\n          icon: (\n            <path\n              strokeLinecap=\"round\"\n              strokeLinejoin=\"round\"\n              d=\"M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25zM6.75 12h.008v.008H6.75V12zm0 3h.008v.008H6.75V15zm0 3h.008v.008H6.75V18z\"\n            />\n          ),\n        },\n        {\n          name: '納品書管理',\n          href: '/shipments',\n          icon: (\n            <path\n              strokeLinecap=\"round\"\n              strokeLinejoin=\"round\"\n              d=\"M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z\"\n            />\n          ),\n        },\n        {\n          name: '請求書発行',\n          href: '/invoices',\n          // ★追加: 請求書\n          icon: (\n            <path\n              strokeLinecap=\"round\"\n              strokeLinejoin=\"round\"\n              d=\"M12 6v12m-3-2.818l.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 11-18 0 9 9 0 0118 0z\"\n            />\n          ),\n        },\n      ],\n    },\n    {\n      title: 'マスタ管理', // 設定系グループ\n      items: [\n        {\n          name: '取引先マスタ',\n          href: '/partners',\n          icon: (\n            <path\n              strokeLinecap=\"round\"\n              strokeLinejoin=\"round\"\n              d=\"M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z\"\n            />\n          ),\n        },\n        {\n          name: '製品マスタ',\n          href: '/products',\n          icon: (\n            <path\n              strokeLinecap=\"round\"\n              strokeLinejoin=\"round\"\n              d=\"M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z\"\n            />\n          ),\n        },\n        {\n          name: '製品単価リスト',\n          href: '/prices',\n          icon: (\n            <path\n              strokeLinecap=\"round\"\n              strokeLinejoin=\"round\"\n              d=\"M12 6v12m-3-2.818l.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 11-18 0 9 9 0 0118 0z\"\n            />\n          ),\n        },\n        {\n          name: 'ユーザー管理',\n          href: '/users',\n          icon: (\n            <path\n              strokeLinecap=\"round\"\n              strokeLinejoin=\"round\"\n              d=\"M17.982 18.725A7.488 7.488 0 0012 15.75a7.488 7.488 0 00-5.982 2.975m11.963 0a9 9 0 10-11.963 0m11.963 0A8.966 8.966 0 0112 21a8.966 8.966 0 01-5.982-2.275M15 9.75a3 3 0 11-6 0 3 3 0 016 0z\"\n            />\n          ),\n        },\n      ],\n    },\n  ];\n\n  return (\n    <div\n      className={`flex flex-col h-screen bg-gray-900 text-white transition-all duration-300 ease-in-out ${\n        isExpanded ? 'w-64' : 'w-16'\n      } relative z-20`}\n      onMouseEnter={() => setIsHovered(true)}\n      onMouseLeave={() => setIsHovered(false)}\n    >\n      {/* ヘッダー */}\n      <div className=\"flex h-16 items-center justify-between px-4 bg-gray-800 flex-shrink-0\">\n        {isExpanded ? (\n          <span className=\"text-xl font-bold tracking-wider truncate\">\n            Otsu Denki\n          </span>\n        ) : (\n          <span className=\"text-xl font-bold mx-auto\">OD</span>\n        )}\n\n        {isExpanded && (\n          <button\n            onClick={togglePin}\n            className={`p-1 rounded-md hover:bg-gray-700 transition-colors ${isPinned ? 'text-indigo-400' : 'text-gray-400'}`}\n            title={isPinned ? 'サイドバーを固定解除' : 'サイドバーを固定'}\n          >\n            {isPinned ? (\n              <svg\n                xmlns=\"http://www.w3.org/2000/svg\"\n                viewBox=\"0 0 24 24\"\n                fill=\"currentColor\"\n                className=\"w-5 h-5\"\n              >\n                <path\n                  fillRule=\"evenodd\"\n                  d=\"M6.32 2.577a49.255 49.255 0 0111.36 0c1.497.174 2.57 1.46 2.57 2.93V21a.75.75 0 01-1.085.67L12 18.089l-7.165 3.583A.75.75 0 013.75 21V5.507c0-1.47 1.073-2.756 2.57-2.93z\"\n                  clipRule=\"evenodd\"\n                />\n              </svg>\n            ) : (\n              <svg\n                xmlns=\"http://www.w3.org/2000/svg\"\n                fill=\"none\"\n                viewBox=\"0 0 24 24\"\n                strokeWidth={1.5}\n                stroke=\"currentColor\"\n                className=\"w-5 h-5\"\n              >\n                <path\n                  strokeLinecap=\"round\"\n                  strokeLinejoin=\"round\"\n                  d=\"M17.593 3.322c1.1.128 1.907 1.077 1.907 2.185V21L12 17.25 4.5 21V5.507c0-1.108.806-2.057 1.907-2.185a48.507 48.507 0 0111.186 0z\"\n                />\n              </svg>\n            )}\n          </button>\n        )}\n      </div>\n\n      {/* メニューリスト */}\n      <nav className=\"flex-1 py-4 px-2 overflow-x-hidden overflow-y-auto custom-scrollbar\">\n        {menuGroups.map((group, groupIndex) => (\n          <div key={groupIndex} className=\"mb-6\">\n            {/* グループタイトル (展開時のみ表示) */}\n            {group.title && isExpanded && (\n              <p className=\"px-3 mb-2 text-xs font-bold text-gray-500 uppercase tracking-wider\">\n                {group.title}\n              </p>\n            )}\n            {/* 区切り線 (縮小時はタイトル代わり) */}\n            {group.title && !isExpanded && (\n              <div className=\"my-2 border-t border-gray-700 mx-2\" />\n            )}\n\n            <div className=\"space-y-1\">\n              {group.items.map((item) => {\n                const isActive =\n                  pathname === item.href ||\n                  pathname.startsWith(`${item.href}/`);\n                return (\n                  <Link\n                    key={item.name}\n                    href={item.href}\n                    className={`flex items-center rounded-md px-3 py-2 text-sm font-medium transition-colors whitespace-nowrap ${\n                      isActive\n                        ? 'bg-indigo-600 text-white'\n                        : 'text-gray-300 hover:bg-gray-800 hover:text-white'\n                    }`}\n                  >\n                    <div\n                      className={`min-w-[1.25rem] w-5 h-5 flex items-center justify-center ${isActive ? 'text-white' : 'text-gray-400'}`}\n                    >\n                      <svg\n                        xmlns=\"http://www.w3.org/2000/svg\"\n                        fill=\"none\"\n                        viewBox=\"0 0 24 24\"\n                        strokeWidth={1.5}\n                        stroke=\"currentColor\"\n                        className=\"w-6 h-6\"\n                      >\n                        {item.icon}\n                      </svg>\n                    </div>\n                    <span\n                      className={`ml-3 transition-opacity duration-200 ${isExpanded ? 'opacity-100' : 'opacity-0 w-0'}`}\n                    >\n                      {item.name}\n                    </span>\n                  </Link>\n                );\n              })}\n            </div>\n          </div>\n        ))}\n      </nav>\n\n      {/* フッター */}\n      <div className=\"border-t border-gray-800 p-4 flex-shrink-0\">\n        <div\n          className={`flex items-center ${!isExpanded ? 'justify-center' : ''}`}\n        >\n          <div className=\"h-8 w-8 rounded-full bg-indigo-500 flex items-center justify-center text-sm font-bold text-white flex-shrink-0\">\n            {user?.email?.charAt(0).toUpperCase()}\n          </div>\n          {isExpanded && (\n            <div className=\"ml-3 truncate\">\n              <p className=\"text-sm font-medium text-white truncate max-w-[10rem]\">\n                {user?.email}\n              </p>\n              <button\n                onClick={handleSignOut}\n                className=\"text-xs text-gray-400 hover:text-white mt-1\"\n              >\n                ログアウト\n              </button>\n            </div>\n          )}\n        </div>\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hibino\\otsudenki-portal\\src\\middleware.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hibino\\otsudenki-portal\\src\\types\\models.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hibino\\otsudenki-portal\\src\\utils\\supabase\\client.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hibino\\otsudenki-portal\\src\\utils\\supabase\\middleware.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'options' is defined but never used.","line":18,"column":48,"nodeType":"Identifier","messageId":"unusedVar","endLine":18,"endColumn":55}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createServerClient } from '@supabase/ssr';\nimport { NextResponse, type NextRequest } from 'next/server';\n\nexport async function updateSession(request: NextRequest) {\n  let supabaseResponse = NextResponse.next({\n    request,\n  });\n\n  const supabase = createServerClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\n    {\n      cookies: {\n        getAll() {\n          return request.cookies.getAll();\n        },\n        setAll(cookiesToSet) {\n          cookiesToSet.forEach(({ name, value, options }) =>\n            request.cookies.set(name, value)\n          );\n          supabaseResponse = NextResponse.next({\n            request,\n          });\n          cookiesToSet.forEach(({ name, value, options }) =>\n            supabaseResponse.cookies.set(name, value, options)\n          );\n        },\n      },\n    }\n  );\n\n  // ユーザー情報を取得\n  const {\n    data: { user },\n  } = await supabase.auth.getUser();\n\n  // 未ログイン状態で、ログイン画面以外に行こうとしたら、ログイン画面に強制送還\n  if (\n    !user &&\n    !request.nextUrl.pathname.startsWith('/login') &&\n    !request.nextUrl.pathname.startsWith('/auth')\n  ) {\n    const url = request.nextUrl.clone();\n    url.pathname = '/login';\n    return NextResponse.redirect(url);\n  }\n\n  return supabaseResponse;\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\hibino\\otsudenki-portal\\src\\utils\\supabase\\server.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]